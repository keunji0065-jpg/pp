<!DOCTYPE html>
<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ìºì‹œ ë°©ì§€ ë©”íƒ€ íƒœê·¸ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO (ìŠ¤ë§ˆíŠ¸ ìë™ë§¤ì¹­ ì™„ë²½ìˆ˜ì •)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'] }, 
                    colors: { brand: { 50: '#f0f4f8', 500: '#627d98', 600: '#486581', 700: '#334e68' }, kakao: '#FEE500' } 
                } 
            } 
        }
    </script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        body { font-family: 'NanumSquareNeo', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .processed-chat { text-decoration: line-through; background-color: #f1f5f9 !important; color: #94a3b8 !important; opacity: 0.6; }
        .selected-chat-active { border-left: 3px solid #3b82f6; background-color: #eff6ff; }
        .keyword-detected { border: 2px solid #60a5fa; background-color: #eff6ff; }
        .copy-anim { animation: copySuccess 0.3s ease-in-out; }
        .animate-pop { animation: pop 0.2s ease-out; }
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes copySuccess { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* ì²´í¬ë°•ìŠ¤ ì»¤ìŠ¤í…€ */
        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.4em;
            height: 1.4em;
            border: 2px solid #cbd5e1;
            border-radius: 4px;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.8em;
            height: 0.8em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            background-color: white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        const DEFAULT_GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-xAIb3GT5gRO69jwJu_wROo-2UuozJ8fY-MAeuEtllmAIbu_J-Uh5oPX71YJ9Omnhbw/exec";
        const FIXED_BANK_ACCOUNT = "ì¹´ì¹´ì˜¤ë±…í¬ ê¹€ì„ ì •\n7942 18 01611";
        const DEFAULT_CUSTOMER_SHEET_ID = "1zlL6R8iCy-6ZRMqj6dbefhkwSyRzHibDYBNJLmE35bM";
        const APP_PASSWORD = "003637";
        
        const Icon = ({ name, className="", weight="regular", size }) => <i className={`ph ph-${name} ${className}`} data-phosphor-icon-weight={weight} style={{fontSize: size}}></i>;
        const normalizeString = (str) => String(str || '').replace(/[\s\(\)\[\]\{\}\-\_\.\,\/]/g, '').toLowerCase();

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { return initialValue; }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) { console.log(error); }
            };
            return [storedValue, setValue];
        };

        const downloadExcel = (data, fileName) => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString()}.xlsx`);
        };

        const Modal = ({ isOpen, type, message, onConfirm, onCancel, initialValue }) => {
            const [inputValue, setInputValue] = useState(initialValue || '');
            const inputRef = useRef(null);
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (!isOpen) return;
                    if (type !== 'prompt') { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); onConfirm(); } } 
                    else { if (e.key === 'Enter') onConfirm(inputValue); }
                    if (e.key === 'Escape' && type !== 'alert') onCancel();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [isOpen, type, inputValue, onConfirm, onCancel]);
            
            useEffect(() => { if (isOpen && type === 'prompt' && inputRef.current) { setInputValue(initialValue || ''); setTimeout(() => inputRef.current.focus(), 100); } }, [isOpen, type, initialValue]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] animate-pop" onClick={type === 'alert' ? () => onConfirm() : undefined}>
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-80 max-w-sm" onClick={e => e.stopPropagation()}>
                        <div className="mb-4">
                            <h3 className="text-lg font-bold text-center text-gray-800 mb-2">{type === 'confirm' ? 'í™•ì¸' : type === 'prompt' ? 'ì…ë ¥' : 'ì•Œë¦¼'}</h3>
                            <p className="text-sm text-gray-600 text-center whitespace-pre-wrap leading-relaxed">{message}</p>
                        </div>
                        {type === 'prompt' && (<input ref={inputRef} type="text" value={inputValue} onChange={(e) => setInputValue(e.target.value)} className="w-full border rounded-lg px-3 py-2 mb-5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50"/>)}
                        <div className="flex gap-2">
                            {type !== 'alert' && (<button onClick={onCancel} className="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors">ì·¨ì†Œ</button>)}
                            <button onClick={() => type === 'prompt' ? onConfirm(inputValue) : onConfirm()} className="flex-1 py-2.5 rounded-lg text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-sm">í™•ì¸</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); if (password === APP_PASSWORD) { onLogin(); } else { setError(true); setTimeout(() => setError(false), 1000); } };
            return (
                <div className="flex flex-col items-center justify-center h-screen bg-slate-100 text-slate-700">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-80 text-center border border-slate-200">
                        <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="lock-key" size={32} weight="fill"/></div>
                        <h2 className="text-xl font-bold mb-1 text-slate-800">ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO</h2>
                        <form onSubmit={handleSubmit} className="flex flex-col gap-3 mt-6">
                            <input type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" value={password} onChange={(e) => setPassword(e.target.value)} className={`w-full border rounded-lg px-3 py-2.5 text-sm text-center outline-none transition-all ${error ? 'border-red-500 ring-2 ring-red-100 bg-red-50' : 'focus:border-indigo-500 focus:ring-2 ring-indigo-100'}`} autoFocus />
                            <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 rounded-lg shadow-sm transition-colors text-sm">ì ‘ì†í•˜ê¸°</button>
                        </form>
                        {error && <p className="text-xs text-red-500 mt-3 font-bold animate-pulse">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>}
                    </div>
                </div>
            );
        };

        const LiveTab = ({ orders, setOrders, productHistory, setProductHistory, quickShipping, shippingOverrides, setShippingOverrides, bankAccount, googleScriptUrl, addresses, cardPayments, setCardPayments, resetAllStatus, matchedDeposits, setMatchedDeposits, depositorNames, setDepositorNames, clickedChats, setClickedChats, openModal, keywords, setKeywords, sentAddressRequests, setSentAddressRequests, deletedDepositIds, setDeletedDepositIds, checkedOrders, setCheckedOrders, addressMapping, setAddressMapping, templateConfig, specialCustomers, inventory }) => {
            const [chats, setChats] = useState([]);
            const [serverDeposits, setServerDeposits] = useState([]);
            const [manualDeposits, setManualDeposits] = useState([]);
            const [selectedNick, setSelectedNick] = useState(null);
            const [manualNick, setManualNick] = useState('');
            const [manualProduct, setManualProduct] = useState('');
            const [newDepositName, setNewDepositName] = useState('');
            const [newDepositAmount, setNewDepositAmount] = useState('');
            const [chatSearch, setChatSearch] = useState('');
            const [depositSearch, setDepositSearch] = useState('');
            const [orderSearch, setOrderSearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [keywordInput, setKeywordInput] = useState('');
            const [showKeywordOnly, setShowKeywordOnly] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState({ code: 'loading', msg: 'ì—°ê²° ì¤‘...' });
            const [copyStatus, setCopyStatus] = useState({});
            const [isSaving, setIsSaving] = useState(false);
            const [editingShippingNick, setEditingShippingNick] = useState(null);
            const [editingQuantityId, setEditingQuantityId] = useState(null);
            const [currentSearchTerm, setCurrentSearchTerm] = useState('');

            const fetchData = async () => {
                if (!googleScriptUrl) { setConnectionStatus({ code: 'error_config', msg: 'ì„¤ì •í•„ìš”' }); return; }
                try {
                    const fetchUrl = `${googleScriptUrl}?t=${Date.now()}`;
                    const res = await fetch(fetchUrl); 
                    if (!res.ok) throw new Error();
                    const text = await res.text();
                    if (text.trim().startsWith("<!DOCTYPE")) { setConnectionStatus({ code: 'error_auth', msg: 'ê¶Œí•œí™•ì¸' }); return; }
                    const data = JSON.parse(text);
                    if (data.chats) {
                        const cleanChats = data.chats.map(chat => ({ ...chat, nickname: String(chat.nickname).replace(/@/g, '').trim() }));
                        setChats(prev => JSON.stringify(prev) !== JSON.stringify(cleanChats) ? cleanChats : prev);
                        setConnectionStatus({ code: 'success', msg: 'ğŸŸ¢ ì—°ê²°ë¨' });
                    }
                    if (data.deposits) {
                        const stableDeposits = data.deposits.map((d, i) => ({ ...d, id: d.uid || `dep_${d.name}_${d.amount}_${i}`, source: 'server' }));
                        setServerDeposits(prev => JSON.stringify(prev) !== JSON.stringify(stableDeposits) ? stableDeposits : prev);
                    }
                } catch (e) { setConnectionStatus({ code: 'error_fetch', msg: 'ì¬ì—°ê²°ì¤‘' }); }
            };
            useEffect(() => { fetchData(); const interval = setInterval(fetchData, 5000); return () => clearInterval(interval); }, [googleScriptUrl]);

            const allDeposits = useMemo(() => [...manualDeposits, ...serverDeposits], [manualDeposits, serverDeposits]);
            
            // ìŠ¤ë§ˆíŠ¸ ìë™ ë§¤ì¹­ ë¡œì§ (ì´ë¦„ + ê¸ˆì•¡ ì¼ì¹˜ í™•ì¸ ì™„ë²½ ì ìš©)
            useEffect(() => {
                if (allDeposits.length === 0 || orders.length === 0) return;

                let updatedOrders = [...orders];
                let newMatchedIds = new Set(matchedDeposits);
                let hasChanges = false;

                // 1. í˜„ì¬ ê³ ê°ë³„ ì”ì•¡ ê³„ì‚°
                const customerBalances = {};
                updatedOrders.forEach(o => {
                    if (o.isCancelled) return;
                    if (!customerBalances[o.customer]) {
                        const currentShipping = shippingOverrides[o.customer] !== undefined ? shippingOverrides[o.customer] : Number(quickShipping);
                        customerBalances[o.customer] = { productTotal: 0, depositTotal: 0, shipping: currentShipping, activeItemsCount: 0 };
                    }
                    customerBalances[o.customer].productTotal += Number(o.price);
                    customerBalances[o.customer].depositTotal += (o.deposit || 0);
                    customerBalances[o.customer].activeItemsCount += 1;
                });

                Object.keys(customerBalances).forEach(nick => {
                    const cb = customerBalances[nick];
                    cb.grandTotal = cb.productTotal + (cb.activeItemsCount > 0 ? cb.shipping : 0);
                    cb.balance = cb.grandTotal - cb.depositTotal;
                });

                // 2. ì…ê¸ˆ ë‚´ì—­ ìˆœíšŒí•˜ë©° ìë™ ë§¤ì¹­
                allDeposits.forEach(deposit => {
                    if (newMatchedIds.has(deposit.id) || deletedDepositIds.has(deposit.id)) return;

                    const depositNameClean = normalizeString(deposit.name);
                    if (depositNameClean.length < 2) return; 

                    let exactMatches = [];
                    
                    Object.keys(customerBalances).forEach(nick => {
                        const savedRealName = depositorNames[nick] ? normalizeString(depositorNames[nick]) : '';
                        const nickClean = normalizeString(nick);
                        // ì™„ì „ ì¼ì¹˜ ë˜ëŠ” ë¶€ë¶„ í¬í•¨(ìˆ˜ë™ ë§¤ì¹­ ê¸°ì¤€ê³¼ ë™ì¼)
                        if (savedRealName === depositNameClean || 
                            nickClean === depositNameClean || 
                            (depositNameClean.length >= 2 && nickClean.length >= 2 && (nickClean.includes(depositNameClean) || depositNameClean.includes(nickClean)))) {
                            exactMatches.push(nick);
                        }
                    });

                    exactMatches = [...new Set(exactMatches)]; // ì¤‘ë³µ ì œê±°
                    let matchedCustomer = null;
                    const depositAmount = Number(deposit.amount);

                    if (exactMatches.length === 1) {
                        // ë”± 1ëª…ë§Œ ê²€ìƒ‰ë˜ë©´ ë§¤ì¹­
                        matchedCustomer = exactMatches[0];
                    } else if (exactMatches.length > 1) {
                        // ë™ëª…ì´ì¸ ë“± ì—¬ëŸ¬ ëª… ê²€ìƒ‰ë˜ë©´ 'ì”ì•¡'ì´ ì¼ì¹˜í•˜ëŠ” ì‚¬ëŒì„ ë§¤ì¹­
                        const amountMatches = exactMatches.filter(nick => customerBalances[nick].balance === depositAmount);
                        if (amountMatches.length === 1) {
                            matchedCustomer = amountMatches[0];
                        }
                    }

                    if (matchedCustomer) {
                        let applied = false;
                        updatedOrders = updatedOrders.map(o => {
                            if (o.customer === matchedCustomer && !applied) {
                                applied = true;
                                return { ...o, deposit: (o.deposit || 0) + depositAmount };
                            }
                            return o;
                        });
                        
                        // í˜„ì¬ ë£¨í”„ì—ì„œ í•´ë‹¹ ê³ ê° ì”ì•¡ ìµœì‹ í™” (ì—°ì† ì…ê¸ˆê±´ ì²˜ë¦¬ ëŒ€ë¹„)
                        customerBalances[matchedCustomer].depositTotal += depositAmount;
                        customerBalances[matchedCustomer].balance -= depositAmount;
                        
                        newMatchedIds.add(deposit.id);
                        hasChanges = true;
                    }
                });

                // ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•´ ë³€ê²½ì ì´ ìˆì„ ë•Œë§Œ State ì—…ë°ì´íŠ¸
                if (hasChanges) {
                    setOrders(updatedOrders);
                    setMatchedDeposits(newMatchedIds);
                }
            }, [allDeposits, orders, matchedDeposits, depositorNames, deletedDepositIds, shippingOverrides, quickShipping]);

            const findAddress = (nick) => {
                if (addressMapping[nick]) return addresses.find(a => normalizeString(a.nickname) === normalizeString(addressMapping[nick]));
                return addresses.find(a => normalizeString(a.nickname) === normalizeString(nick));
            };
            const findAddressSuggestions = (nick) => {
                if (!nick) return [];
                const cleanNick = normalizeString(nick);
                if (cleanNick.length < 2) return [];
                return addresses.filter(a => {
                    const cleanAddrNick = normalizeString(a.nickname);
                    return cleanAddrNick !== cleanNick && (cleanAddrNick.includes(cleanNick) || cleanNick.includes(cleanAddrNick));
                }).map(a => a.nickname).slice(0, 3);
            };
             const getSpecialCustomer = (nick) => {
                if (!specialCustomers) return null;
                const nickNorm = normalizeString(nick);
                const key = Object.keys(specialCustomers).find(k => normalizeString(k) === nickNorm);
                return key ? specialCustomers[key] : null;
            };
            
            const renderSpecialBadge = (nick) => {
                const info = getSpecialCustomer(nick);
                if (!info) return null;
                let bgColor = 'bg-gray-100 text-gray-600', icon = 'user', text = 'ê¸°íƒ€';
                if (info.type === 'black') { bgColor = 'bg-red-100 text-red-600'; icon = 'prohibit'; text = 'ì§„ìƒ'; } 
                else if (info.type === 'vip') { bgColor = 'bg-yellow-300 text-yellow-900'; icon = 'crown'; text = 'VIP'; } 
                else if (info.type === 'manager') { bgColor = 'bg-emerald-100 text-emerald-700'; icon = 'shield-check'; text = 'ê´€ë¦¬ì'; }
                return <span className={`${bgColor} px-1 rounded text-[10px] flex items-center gap-0.5 ml-1 cursor-help shrink-0`} title={info.memo}><Icon name={icon} weight="fill" /><span className="max-w-[60px] truncate">{text}</span></span>;
            };

            const addOrderLogic = (nickname, content, qty = 1, forceNewRow = false) => {
                const cleanNick = String(nickname || '').replace(/@/g, '').trim();
                const initialProduct = content || '';
                let initialPrice = 0;
                if (inventory && inventory[initialProduct]) initialPrice = Number(inventory[initialProduct].price) || 0;
                else initialPrice = Number(productHistory[initialProduct]) || 0;
                
                if (initialProduct && !productHistory[initialProduct] && !inventory[initialProduct]) {
                     setProductHistory(prev => ({ ...prev, [initialProduct]: 0 }));
                }

                setCheckedOrders(prev => { const next = new Set(prev); next.delete(cleanNick); return next; });
                setSelectedNick(cleanNick); setOrderSearch('');
                setOrders(prev => {
                    if (!forceNewRow && initialProduct !== '') {
                        const existIdx = prev.findIndex(o => o.customer === cleanNick && o.product === initialProduct && !o.isCancelled);
                        if (existIdx >= 0) { const next = [...prev]; next[existIdx] = { ...next[existIdx], quantity: next[existIdx].quantity + qty, price: (next[existIdx].quantity + qty) * initialPrice, isUnmodified: true }; return next; }
                    }
                    const newOrder = { id: Date.now(), customer: cleanNick, product: initialProduct, quantity: qty, price: initialPrice, deposit: 0, originalText: initialProduct, isCancelled: false, isUnmodified: true };
                    return [newOrder, ...prev];
                });
            };
            
            const handleChatClick = (chat) => { setClickedChats(prev => new Set(prev).add(chat.id)); addOrderLogic(chat.nickname, chat.content, 1, true); };
            const handleManualSubmit = (e) => { 
                e.preventDefault(); 
                if (!manualNick.trim()) return openModal("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert'); 
                addOrderLogic(manualNick, manualProduct, 1); 
                setManualProduct(''); 
                setCurrentSearchTerm('');
            };
            const handleAddManualDeposit = (e) => { e.preventDefault(); if (!newDepositName.trim() || !newDepositAmount) return openModal("ì…ê¸ˆìëª…/ê¸ˆì•¡ í•„ìˆ˜", 'alert'); const newDep = { id: `manual_${Date.now()}`, name: newDepositName, amount: newDepositAmount, source: 'manual' }; setManualDeposits(prev => [newDep, ...prev]); setNewDepositName(''); setNewDepositAmount(''); };
            
            const handleDepositClick = (deposit) => {
                const depositId = deposit.id;
                const currentMatched = matchedDeposits || new Set();
                if (currentMatched.has(depositId)) {
                    openModal("ì´ ì…ê¸ˆ í™•ì¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => {
                        if (selectedNick) {
                            const depositAmount = Number(deposit.amount);
                            setOrders(prev => {
                                const targetOrders = prev.filter(o => o.customer === selectedNick);
                                const otherOrders = prev.filter(o => o.customer !== selectedNick);
                                if (targetOrders.length === 0) return prev;
                                const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: Math.max(0, (o.deposit || 0) - depositAmount) }; return o; });
                                return [...updatedTargets, ...otherOrders];
                            });
                        }
                        setMatchedDeposits(prev => { const next = new Set(prev); next.delete(depositId); return next; });
                    });
                    return;
                }
                const depositNameClean = normalizeString(deposit.name);
                let matchedCustomer = orders.map(o => o.customer).find(c => {
                    const savedRealName = depositorNames[c] ? normalizeString(depositorNames[c]) : '';
                    return savedRealName === depositNameClean || normalizeString(c) === depositNameClean;
                });
                if (!matchedCustomer) {
                     matchedCustomer = orders.map(o => o.customer).find(c => {
                        const nickClean = normalizeString(c); 
                        return (depositNameClean.length >= 2 && nickClean.length >= 2) && (nickClean.includes(depositNameClean) || depositNameClean.includes(nickClean));
                     });
                }
                if (matchedCustomer) {
                    if (selectedNick === matchedCustomer) {
                        const depositAmount = Number(deposit.amount);
                        setOrders(prev => {
                            const targetOrders = prev.filter(o => o.customer === selectedNick);
                            const otherOrders = prev.filter(o => o.customer !== selectedNick);
                            if (targetOrders.length === 0) return prev;
                            const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: (o.deposit || 0) + depositAmount }; return o; });
                            return [...updatedTargets, ...otherOrders];
                        });
                        setMatchedDeposits(prev => new Set(prev).add(depositId));
                    } else { setSelectedNick(matchedCustomer); setOrderSearch(matchedCustomer); }
                } else {
                     setOrderSearch(deposit.name);
                     if (selectedNick) {
                         openModal(`ì…ê¸ˆìëª…('${deposit.name}')ê³¼ ì¼ì¹˜í•˜ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ì„ íƒëœ '${selectedNick}'ë‹˜ì—ê²Œ ê°•ì œë¡œ ì…ê¸ˆ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'confirm', () => {
                             const depositAmount = Number(deposit.amount);
                             setOrders(prev => {
                                 const targetOrders = prev.filter(o => o.customer === selectedNick);
                                 const otherOrders = prev.filter(o => o.customer !== selectedNick);
                                 if (targetOrders.length === 0) return prev;
                                 const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: (o.deposit || 0) + depositAmount }; return o; });
                                 return [...updatedTargets, ...otherOrders];
                             });
                             setMatchedDeposits(prev => new Set(prev).add(depositId));
                         });
                     }
                }
            };

            const handleDeleteManualDeposit = (id) => { openModal("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => { setManualDeposits(prev => prev.filter(d => d.id !== id)); setMatchedDeposits(prev => { const next = new Set(prev); next.delete(id); return next; }); }); };
            const handleDeleteDepositItem = (id) => { openModal("ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => { setManualDeposits(prev => prev.filter(d => d.id !== id)); setDeletedDepositIds(prev => new Set(prev).add(id)); setMatchedDeposits(prev => { const next = new Set(prev); next.delete(id); return next; }); }); };
            const handleFullDepositToggle = (nick, grandTotal, currentDeposit) => { const isPaid = currentDeposit >= grandTotal; if (isPaid) { openModal("ì…ê¸ˆ ì·¨ì†Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => { setOrders(prev => prev.map(o => o.customer === nick ? { ...o, deposit: 0 } : o)); }); } else { setOrders(prev => { let processed = false; return prev.map(o => { if (o.customer === nick) { if (!processed) { processed = true; return { ...o, deposit: grandTotal }; } else { return { ...o, deposit: 0 }; } } return o; }); }); } };
            const resetUserDeposit = (nick) => { openModal("ì…ê¸ˆì•¡ 0ì› ì´ˆê¸°í™”?", 'confirm', () => { setOrders(prev => prev.map(o => o.customer === nick ? { ...o, deposit: 0 } : o)); }); };
            const handleProductChange = (id, field, value) => { if (field === 'product') { setCurrentSearchTerm(value); setProductHistory(prev => ({ ...prev, [value]: prev[value] || 0 })); } setOrders(prev => prev.map(o => { if (o.id === id) { const newOrder = { ...o, [field]: value, isUnmodified: false }; let unitPrice = 0; if(field === 'product') { if(inventory && inventory[value]) unitPrice = Number(inventory[value].price); else if(productHistory[value]) unitPrice = Number(productHistory[value]); newOrder.price = newOrder.quantity * (unitPrice || 0); } if (field === 'price' && o.product) { const uPrice = value / o.quantity; setProductHistory(h => ({ ...h, [o.product]: uPrice })); } return newOrder; } return o; })); };
            const handleQuantityUpdate = (itemId, newQtyVal) => { const newQty = parseInt(newQtyVal, 10); if (isNaN(newQty) || newQty < 1) return setEditingQuantityId(null); setOrders(prev => prev.map(o => { if (o.id === itemId) { let unitPrice = 0; if (o.quantity > 0 && o.price > 0) { unitPrice = o.price / o.quantity; } else if (productHistory[o.product]) { unitPrice = productHistory[o.product]; } return { ...o, quantity: newQty, price: unitPrice * newQty, isUnmodified: false }; } return o; })); setEditingQuantityId(null); };
            const handleShippingChange = (nick, val) => { setShippingOverrides(prev => ({ ...prev, [nick]: Number(val) })); };
            const handleNicknameEdit = (oldNick) => { openModal(`'${oldNick}' ë‹‰ë„¤ì„ ë³€ê²½`, 'prompt', (newNickRaw) => { if (newNickRaw && newNickRaw !== oldNick) { const newNick = String(newNickRaw || '').replace(/@/g, '').trim(); setOrders(prev => prev.map(o => o.customer === oldNick ? { ...o, customer: newNick } : o)); if (shippingOverrides[oldNick]) { const newOverrides = { ...shippingOverrides, [newNick]: shippingOverrides[oldNick] }; delete newOverrides[oldNick]; setShippingOverrides(newOverrides); } if (selectedNick === oldNick) setSelectedNick(newNick); } }, null, oldNick); };
            const handleOrderCancel = (id) => { setOrders(prev => prev.map(o => o.id === id ? { ...o, isCancelled: !o.isCancelled } : o)); };
            const handleOrderDelete = (id) => { openModal("ì£¼ë¬¸ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => { setOrders(prev => prev.filter(o => o.id !== id)); }); };
            const handleOrderCheckToggle = (nick) => { setCheckedOrders(prev => { const next = new Set(prev); if (next.has(nick)) next.delete(nick); else next.add(nick); return next; }); };
            const handleLoadOrders = async () => { openModal("ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', async () => { if (!googleScriptUrl) return; try { const res = await fetch(`${googleScriptUrl}?action=get_orders&t=${Date.now()}`); const data = await res.json(); if (data && data.orders) { const loadedOrders = data.orders.map((o, idx) => ({ id: Date.now() + idx, customer: o.nickname || o.customer, product: o.product, quantity: Number(o.qty || o.quantity), price: Number(o.price), deposit: Number(o.deposit), isCancelled: false })); setOrders(loadedOrders); openModal("ë¡œë“œ ì™„ë£Œ", 'alert'); } } catch(e) { openModal("ë¡œë“œ ì‹¤íŒ¨", 'alert'); } }); };
            const autoSaveToGoogleSheet = async () => { if (!googleScriptUrl || Object.keys(orders).length === 0) return; setIsSaving(true); const saveList = orders.filter(o=>!o.isCancelled).map(o => { let addr = findAddress(o.customer) || {}; const currentShipping = shippingOverrides[o.customer] !== undefined ? shippingOverrides[o.customer] : Number(quickShipping); return { nickname: o.customer, product: o.product, qty: o.quantity, price: o.price, deposit: o.deposit, shipping: currentShipping, grandTotal: 0, address: addr.address || '', zipcode: addr.zipcode || '', phone: addr.phone || '', realname: addr.realname || '', memo: addr.memo || '' }; }); try { await fetch(googleScriptUrl, { method: 'POST', body: JSON.stringify(saveList), mode: 'no-cors' }); } catch(e) { } finally { setIsSaving(false); } };
            useEffect(() => { const saveInterval = setInterval(autoSaveToGoogleSheet, 60000); return () => clearInterval(saveInterval); }, [orders, shippingOverrides, quickShipping, googleScriptUrl]); 
            const handleAddKeyword = (e) => { e.preventDefault(); if(!keywordInput.trim()) return; setKeywords(prev => new Set(prev).add(keywordInput.trim())); setKeywordInput(''); };
            const handleRemoveKeyword = (keyword) => { setKeywords(prev => { const next = new Set(prev); next.delete(keyword); return next; }); };
            const handleAddressMapping = (orderNick, addressNick) => { if (confirm(`'${orderNick}' â†’ '${addressNick}' ì£¼ì†Œ ì—°ê²°?`)) setAddressMapping(prev => ({ ...prev, [orderNick]: addressNick })); };
            const handleAddressUnmapping = (orderNick) => { if (confirm(`ì—°ê²° í•´ì œ?`)) setAddressMapping(prev => { const next = { ...prev }; delete next[orderNick]; return next; }); };
            const toggleCardPayment = (nick) => { setCardPayments(prev => ({ ...prev, [nick]: !prev[nick] })); };

            const copyOrderSheet = (nick, items, grandTotal, depositTotal, balance, isCard) => {
                const activeItems = items.filter(i => !i.isCancelled);
                const addr = findAddress(nick);
                const itemListText = activeItems.map(i => `${i.product}${i.quantity > 1 ? ` ${i.quantity}` : ''} ${Number(i.price).toLocaleString()}ì›`).join('\n');
                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                const { emoji, paidMsg, unpaidPrefix, addrNotice, surveyNotice } = templateConfig;
                
                let msg = `${emoji} ${nick} ë‹˜ ${emoji}\n\n\n${itemListText}\në°°ì†¡ë¹„ ${currentShipping.toLocaleString()}ì›\n\nì´ ì£¼ë¬¸ê¸ˆì•¡ ${grandTotal.toLocaleString()}ì›\n------------------\n`;
                if (isCard) { const cardBase = Math.abs(balance); if (depositTotal > 0) msg += `[ì…ê¸ˆí™•ì¸]\n${depositTotal.toLocaleString()}ì›\n------------------\n\n`; msg += `[ì¹´ë“œê²°ì œ]\nê¸ˆì•¡ ${cardBase.toLocaleString()}ì›\n10% ${(cardBase * 0.1).toLocaleString()}ì›\nğŸ‘‰ì´ ${(cardBase * 1.1).toLocaleString()}ì› ì˜ˆì •\n\ní•¸ë“œí°ë²ˆí˜¸ ë‚¨ê²¨ì£¼ì„¸ìš”ğŸŒ¸\n------------------\n\n`; } 
                else { const isPaid = (balance <= 0) && (grandTotal >= 0) && (activeItems.length > 0); if (depositTotal > 0) msg += `[ì…ê¸ˆí™•ì¸]\n${depositTotal.toLocaleString()}ì›\n------------------\n\n`; if (isPaid) msg += `${paidMsg}\n------------------\n`; else msg += `${unpaidPrefix}\n${(balance > 0 ? balance : 0).toLocaleString()}ì› \n\n${bankAccount}\nì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™\n------------------\n\n`; }
                
                if (addr && addr.address) msg += `\n[ë°°ì†¡ì§€ í™•ì¸]\n\n${addr.realname || nick}\n${addr.phone || ''}\n${addr.address} ${addr.zipcode ? `(${addr.zipcode})` : ''}\n${addr.memo ? addr.memo + '\n' : ''}\n------------------\n${addrNotice}`;
                else if (!sentAddressRequests.has(nick)) { msg += `\n${surveyNotice}`; setSentAddressRequests(prev => new Set(prev).add(nick)); }
                
                const textArea = document.createElement("textarea"); textArea.value = msg; document.body.appendChild(textArea); textArea.select();
                
                setCheckedOrders(prev => new Set(prev).add(nick));

                try { document.execCommand('copy'); setCopyStatus(prev => ({ ...prev, [nick]: true })); setTimeout(() => { setCopyStatus(prev => ({ ...prev, [nick]: false })); }, 2000); } catch (err) { openModal('ë³µì‚¬ ì‹¤íŒ¨', 'alert'); } document.body.removeChild(textArea);
            };

            const filteredChats = useMemo(() => { let result = chats; const keywordsArray = Array.from(keywords || []); if (showKeywordOnly) result = result.filter(c => keywordsArray.some(k => c.content.includes(k))); if (chatSearch) result = result.filter(c => c.nickname.includes(chatSearch) || c.content.includes(chatSearch)); return result; }, [chats, chatSearch, showKeywordOnly, keywords]);
            const filteredDeposits = useMemo(() => { let result = [...allDeposits]; result = result.filter(d => !deletedDepositIds.has(d.id)); if (depositSearch) result = result.filter(d => (d.name||'').includes(depositSearch) || String(d.amount).includes(depositSearch)); result.sort((a, b) => { const aUsed = matchedDeposits?.has(a.id) || false; const bUsed = matchedDeposits?.has(b.id) || false; if (aUsed && !bUsed) return 1; if (!aUsed && bUsed) return -1; if (selectedNick) { const targetNick = normalizeString(selectedNick); const depositorName = depositorNames[selectedNick] && normalizeString(depositorNames[selectedNick]); const targetReal = depositorName || ''; const nameA = normalizeString(a.name); const nameB = normalizeString(b.name); const getScore = (val, target) => { if (!target || !val) return 10; const v = normalizeString(val); const t = normalizeString(target); if (v === t) return 0; if (v.startsWith(t) || t.startsWith(v)) return 1; if (v.includes(t) || t.includes(v)) return 2; for (let i = 0; i < t.length - 1; i++) { if (v.includes(t.substring(i, i + 2))) return 3; } return 10; }; const scoreA = Math.min(getScore(a.name, targetNick), getScore(a.name, targetReal)); const scoreB = Math.min(getScore(b.name, targetNick), getScore(b.name, targetReal)); if (scoreA !== scoreB) return scoreA - scoreB; } return 0; }); return result; }, [allDeposits, depositSearch, selectedNick, deletedDepositIds, matchedDeposits, depositorNames]);
            
            const filteredProductList = useMemo(() => { 
                const allItems = new Set([...Object.keys(productHistory || {}), ...Object.keys(inventory || {})]); 
                const list = [...allItems].sort(); 
                if (!currentSearchTerm) return list; 
                const term = currentSearchTerm.toLowerCase();
                return list.filter(name => name.toLowerCase().includes(term));
            }, [productHistory, currentSearchTerm, inventory]);

            const totalDepositAmount = useMemo(() => filteredDeposits.reduce((sum, d) => sum + Number(d.amount), 0), [filteredDeposits]);
            
            const filteredGroupedOrders = useMemo(() => { 
                const groups = {}; 
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); }); 
                let groupedArray = Object.entries(groups); 
                groupedArray.sort((a, b) => { const maxTimeA = a[1].length > 0 ? Math.max(...a[1].map(item => item.id)) : 0; const maxTimeB = b[1].length > 0 ? Math.max(...b[1].map(item => item.id)) : 0; return maxTimeB - maxTimeA; }); 
                
                return groupedArray.filter(([nick, items]) => { 
                    const isCard = cardPayments[nick] || false; 
                    const activeItems = items.filter(i => !i.isCancelled); 
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0); 
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping); 
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0); 
                    const grandTotal = productTotal + (activeItems.length > 0 ? currentShipping : 0); 
                    const balance = grandTotal - depositTotal; 
                    const isPaid = (balance <= 0) && (grandTotal >= 0) && (activeItems.length > 0); 
                    
                    if (orderSearch) { 
                        const term = orderSearch.toLowerCase(); 
                        if (!nick.toLowerCase().includes(term) && !items.some(i => i.product && i.product.toLowerCase().includes(term))) return false; 
                    } 
                    
                    if (filterStatus === 'card') { 
                        if (!isCard) return false; 
                    }
                    else if (filterStatus === 'unpaid') { 
                        if (isCard || isPaid) return false; 
                    } 
                    else if (filterStatus === 'paid') { 
                        if (!isPaid || isCard) return false; 
                    } 
                    
                    return true; 
                }); 
            }, [orders, orderSearch, filterStatus, shippingOverrides, quickShipping, cardPayments]);

            const totalItemsCount = useMemo(() => { let count = 0; filteredGroupedOrders.forEach(([_, items]) => { count += items.filter(i => !i.isCancelled).length; }); return count; }, [filteredGroupedOrders]);
            const dashboardStats = useMemo(() => { let totalSales = 0, totalDeposit = 0, totalUnpaid = 0, totalCardExpected = 0; const groups = {}; orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); }); Object.entries(groups).forEach(([nick, items]) => { const activeItems = items.filter(i => !i.isCancelled); if (activeItems.length === 0) return; const isCard = cardPayments[nick]; const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping); const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0); const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0); const grandTotal = productTotal + currentShipping; const balance = grandTotal - depositTotal; totalSales += grandTotal; totalDeposit += depositTotal; if (balance > 0) { if (isCard) totalCardExpected += (balance * 1.1); else totalUnpaid += balance; } }); return { totalSales, totalDeposit, totalUnpaid, totalCardExpected }; }, [orders, shippingOverrides, quickShipping, cardPayments]);

            const renderChatContent = (content, keywordsSet) => {
                if (!keywordsSet || keywordsSet.size === 0) return content;
                const kwArray = Array.from(keywordsSet).filter(k => k.trim());
                if (kwArray.length === 0) return content;
                const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const pattern = new RegExp(`(${kwArray.map(escapeRegExp).join('|')})`, 'gi');
                const parts = content.split(pattern);
                return parts.map((part, i) => {
                    const isMatch = kwArray.some(k => k.toLowerCase() === part.toLowerCase());
                    return isMatch ? <span key={i} className="text-blue-600 font-bold">{part}</span> : part;
                });
            };

            const formatTimeOnly = (val) => {
                if (!val) return '';
                const str = String(val);
                const dt = new Date(str);
                if (!isNaN(dt) && str.length > 10) return dt.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit', hour12: false});
                const match = str.match(/(ì˜¤ì „|ì˜¤í›„)?\s*(\d{1,2}):(\d{2})/);
                if (match) {
                    let h = parseInt(match[2], 10);
                    if (match[1] === 'ì˜¤í›„' && h < 12) h += 12;
                    if (match[1] === 'ì˜¤ì „' && h === 12) h = 0;
                    return `${String(h).padStart(2, '0')}:${match[3]}`;
                }
                return str;
            };

             return (
                <div className="flex h-full gap-2 p-2 overflow-hidden bg-gray-100 text-slate-800">
                    <datalist id="product-list">
                        {filteredProductList.map(name => {
                            let suffix = '';
                            if (inventory && inventory[name]) {
                                const orderedQty = orders.filter(o => o.product === name && !o.isCancelled).reduce((sum, o) => sum + o.quantity, 0);
                                const remaining = inventory[name].stock - orderedQty;
                                suffix = remaining <= 0 ? ' (í’ˆì ˆ)' : ` (ì”ì—¬: ${remaining})`;
                            }
                            const price = inventory && inventory[name] ? inventory[name].price : (productHistory && productHistory[name]);
                            if (price) suffix += ` [${price.toLocaleString()}ì›]`;
                            return <option key={name} value={name} label={suffix} />;
                        })}
                    </datalist>

                    <div className="w-[30%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-indigo-50 border-b flex flex-col gap-2">
                             <div className="font-bold text-indigo-700 flex items-center justify-between"><div className="flex items-center gap-2"><span className="flex items-center gap-1"><Icon name="youtube-logo" weight="fill" className="text-red-600"/> ë¼ì´ë¸Œ ëŒ“ê¸€</span><button onClick={() => setShowKeywordOnly(!showKeywordOnly)} className={`flex items-center justify-center w-6 h-6 rounded-full transition-all ${showKeywordOnly ? 'bg-blue-600 text-white shadow-sm' : 'bg-white text-gray-400 border border-gray-200 hover:text-blue-500'}`}><Icon name="target" weight={showKeywordOnly ? "fill" : "bold"} size={14} /></button></div><span className="text-xs text-gray-500">{filteredChats.length}ê±´</span></div>
                             <div className="flex flex-col gap-1 bg-white p-1 rounded border border-indigo-100 mt-1">
                                <form onSubmit={handleAddKeyword} className="flex gap-1">
                                    <input type="text" value={keywordInput} onChange={(e) => setKeywordInput(e.target.value)} placeholder="í‚¤ì›Œë“œ ì¶”ê°€" className="flex-1 text-xs border rounded px-1 py-0.5 outline-none" />
                                    <button type="submit" className="bg-blue-500 text-white px-2 py-0.5 rounded text-xs font-bold">ì¶”ê°€</button>
                                </form>
                                {keywords.size > 0 && (
                                    <div className="flex flex-wrap gap-1 max-h-16 overflow-y-auto scrollbar-thin p-1 bg-gray-50 border rounded">
                                        {[...keywords].map(k => (
                                            <span key={k} onClick={() => handleRemoveKeyword(k)} className="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full text-[10px] cursor-pointer hover:bg-red-100 hover:text-red-600 flex items-center gap-0.5 shrink-0">
                                                {k} <Icon name="x" weight="bold" size={8}/>
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>
                             <div className="relative mt-2"><Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"/><input type="text" placeholder="ë‹‰ë„¤ì„/ë‚´ìš© ê²€ìƒ‰" value={chatSearch} onChange={e => setChatSearch(e.target.value)} className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-indigo-500 outline-none" /></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-100">
                            {filteredChats.map(chat => {
                                const isMatched = Array.from(keywords).some(k => chat.content.includes(k));
                                const isProcessed = clickedChats?.has(chat.id);
                                const chatClasses = isProcessed ? 'opacity-50 bg-gray-200 line-through border-transparent' : (isMatched ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-300 shadow-sm' : 'bg-white border-gray-200 hover:bg-gray-50');
                                return (
                                    <div key={chat.id} onClick={() => handleChatClick(chat)} className={`p-2 border rounded cursor-pointer transition-all flex flex-col gap-1 ${chatClasses}`}>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className={`font-bold ${isProcessed ? 'text-gray-500' : 'text-gray-900'}`}>{chat.nickname} {renderSpecialBadge(chat.nickname)}</span>
                                            <span className="text-gray-400">{formatTimeOnly(chat.time)}</span>
                                        </div>
                                        <div className="text-sm">{renderChatContent(chat.content, keywords)}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <div className="w-[20%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-yellow-50 border-b flex flex-col gap-2"><div className="font-bold text-yellow-700 flex items-center justify-between"><span className="flex items-center gap-1"><Icon name="money" weight="fill"/> ì…ê¸ˆ ë‚´ì—­</span><span className="text-xs text-gray-500">{filteredDeposits.length}ê±´</span></div><form onSubmit={handleAddManualDeposit} className="flex flex-col gap-1 bg-white p-1 rounded border border-yellow-200"><div className="flex gap-1"><input type="text" value={newDepositName} onChange={(e)=>setNewDepositName(e.target.value)} placeholder="ì…ê¸ˆìëª…" className="w-[60%] text-xs border rounded px-1 py-1" /><input type="number" value={newDepositAmount} onChange={(e)=>setNewDepositAmount(e.target.value)} placeholder="ê¸ˆì•¡" className="w-[40%] text-xs border rounded px-1 py-1" /></div><button type="submit" className="bg-yellow-500 text-white text-xs font-bold py-1 rounded hover:bg-yellow-600">ìˆ˜ë™ ì…ê¸ˆ ì¶”ê°€</button></form><div className="relative"><Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/><input type="text" placeholder="ì…ê¸ˆì/ê¸ˆì•¡ ê²€ìƒ‰" value={depositSearch} onChange={e => setDepositSearch(e.target.value)} className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-yellow-500 outline-none" />{depositSearch && <button onClick={()=>setDepositSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}</div>{selectedNick && <div className="text-[11px] text-blue-600 bg-blue-50 p-1 rounded text-center animate-pulse">ğŸ‘‡ '{selectedNick}'ë‹˜ ë§¤ì¹­</div>}</div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-100">
                            {filteredDeposits.map(d => {
                                const isUsed = matchedDeposits?.has(d.id);
                                const depositNameClean = normalizeString(d.name);
                                const isMatchable = !isUsed && orders.some(o => {
                                    const c = o.customer;
                                    const savedRealName = depositorNames[c] ? normalizeString(depositorNames[c]) : '';
                                    const nickClean = normalizeString(c);
                                    return savedRealName === depositNameClean || nickClean === depositNameClean || (depositNameClean.length >= 2 && nickClean.length >= 2 && (nickClean.includes(depositNameClean) || depositNameClean.includes(nickClean)));
                                });
                                const depositClasses = isUsed ? 'opacity-50 bg-gray-200 line-through border-transparent' : (isMatchable ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-300 shadow-sm' : 'bg-white border-gray-200 hover:bg-gray-50');

                                return (
                                    <div key={d.id} onClick={() => handleDepositClick(d)} className={`relative flex justify-between p-2 border rounded cursor-pointer transition-all group ${depositClasses}`}>
                                        <div className="flex flex-col gap-1">
                                            <span className={`text-sm flex items-center gap-1 ${isUsed ? 'text-gray-500 line-through' : 'text-gray-900'}`}>{d.name} {d.source === 'manual' && <span className="text-[9px] text-gray-400 bg-gray-100 px-1 rounded">ìˆ˜ë™</span>}</span>
                                            <span className="text-[10px] text-gray-500 font-medium">{formatTimeOnly(d.time || d.date)}</span>
                                        </div>
                                        <div className="flex flex-col items-end justify-center">
                                            <span className={`font-mono font-bold text-sm ${isUsed ? 'text-gray-500 line-through' : 'text-blue-600'}`}>+{Number(d.amount).toLocaleString()}</span>
                                            {isUsed && <span className="text-[9px] font-bold text-green-600 bg-green-100 px-1.5 py-0.5 rounded mt-0.5">ë§¤ì¹­ì™„ë£Œ</span>}
                                        </div>
                                        <button onClick={(e)=>{e.stopPropagation(); handleDeleteDepositItem(d.id)}} className="absolute -right-1 -top-1 bg-red-500 text-white rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash" size={10} weight="bold"/></button>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="p-2 bg-white text-center font-bold text-gray-700 text-xs border-t border-gray-200">ì´ ì…ê¸ˆ: <span className="text-green-600">{totalDepositAmount.toLocaleString()}</span>ì›</div>
                    </div>
                    
                    <div className="w-[50%] bg-white border rounded-lg flex flex-col overflow-hidden shadow-sm">
                        <div className="grid grid-cols-4 gap-2 p-2 bg-indigo-50 border-b border-indigo-100 text-center text-xs">
                            <div onClick={()=>setFilterStatus('all')} className={`bg-white p-1 rounded shadow-sm cursor-pointer border-2 transition-all ${filterStatus==='all' ? 'border-indigo-500' : 'border-transparent hover:border-indigo-200'}`}><div className="text-gray-400">ì´ ë§¤ì¶œ</div><div className="font-bold text-indigo-700">{dashboardStats.totalSales.toLocaleString()}</div></div>
                            <div onClick={()=>setFilterStatus('paid')} className={`bg-white p-1 rounded shadow-sm cursor-pointer border-2 transition-all ${filterStatus==='paid' ? 'border-green-500' : 'border-transparent hover:border-green-200'}`}><div className="text-gray-400">ì…ê¸ˆì•¡</div><div className="font-bold text-green-600">{dashboardStats.totalDeposit.toLocaleString()}</div></div>
                            <div onClick={()=>setFilterStatus('unpaid')} className={`bg-white p-1 rounded shadow-sm cursor-pointer border-2 transition-all ${filterStatus==='unpaid' ? 'border-red-500' : 'border-transparent hover:border-red-200'}`}><div className="text-gray-400">ë¯¸ìˆ˜ê¸ˆ</div><div className="font-bold text-red-500">{dashboardStats.totalUnpaid.toLocaleString()}</div></div>
                            <div onClick={()=>setFilterStatus('card')} className={`bg-white p-1 rounded shadow-sm cursor-pointer border-2 transition-all ${filterStatus==='card' ? 'border-purple-500' : 'border-transparent hover:border-purple-200'}`}><div className="text-gray-400">ì¹´ë“œì˜ˆì •</div><div className="font-bold text-purple-600">{dashboardStats.totalCardExpected.toLocaleString()}</div></div>
                        </div>
                        <div className="p-2 bg-white border-b font-bold text-indigo-700 shadow-sm flex flex-col gap-2">
                             <div className="flex justify-between items-center"><span className="text-sm">ğŸ“¦ ì£¼ë¬¸ì„œ ({filteredGroupedOrders.length}ëª…) ({totalItemsCount}ê±´)</span><div className="flex items-center gap-2"><button onClick={handleLoadOrders} className="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold flex items-center gap-1 shadow-sm"><Icon name="cloud-arrow-down" weight="fill"/> ë¶ˆëŸ¬ì˜¤ê¸°</button><button onClick={resetAllStatus} className="bg-rose-500 text-white px-2 py-1 rounded text-xs font-bold hover:bg-rose-600 flex items-center gap-1" title="ì´ˆê¸°í™”"><Icon name="trash" weight="fill"/> ì´ˆê¸°í™”</button><div className={`px-2 py-1 rounded text-xs font-bold flex items-center gap-1 ${isSaving ? 'bg-indigo-100 text-indigo-700' : 'bg-green-100 text-green-700'}`}>{isSaving ? <Icon name="spinner" className="animate-spin" /> : <Icon name="cloud-check" weight="fill" />} {isSaving ? "ì €ì¥ì¤‘" : "ìë™ì €ì¥"}</div></div></div>
                             <div className="flex gap-2 items-center">
                                 <div className="flex-1 flex gap-1 items-center bg-indigo-50 p-1 rounded border border-indigo-100"><span className="text-xs font-bold text-indigo-600 whitespace-nowrap pl-1">ğŸ–ï¸</span>
                                 <form onSubmit={handleManualSubmit} className="flex gap-1 w-full">
                                    <input type="text" placeholder="ë‹‰ë„¤ì„" value={manualNick} onChange={e => setManualNick(e.target.value)} className="w-20 border rounded px-2 py-1 text-xs outline-none" />
                                    <input type="text" list="product-list" placeholder="ìƒí’ˆëª…" value={manualProduct} onChange={e => { setManualProduct(e.target.value); setCurrentSearchTerm(e.target.value); }} className="flex-1 border rounded px-2 py-1 text-xs outline-none" />
                                    <button type="submit" className="bg-indigo-600 text-white px-2 py-1 rounded text-xs font-bold hover:bg-indigo-700">ï¼‹</button>
                                </form>
                                </div><div className="w-32 relative"><Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"/><input type="text" placeholder="ê²€ìƒ‰..." value={orderSearch} onChange={(e) => setOrderSearch(e.target.value)} className="w-full pl-6 pr-2 py-1 border rounded text-xs outline-none" />{orderSearch && <button onClick={()=>setOrderSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={10}/></button>}</div></div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-100">
                             {filteredGroupedOrders.map(([nick, items]) => {
                                 const isSelected = selectedNick === nick;
                                 const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                                 const activeItems = items.filter(i => !i.isCancelled);
                                 const grandTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0) + (activeItems.length > 0 ? currentShipping : 0);
                                 const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                                 const balance = grandTotal - depositTotal;
                                 const isCard = cardPayments[nick];
                                 const isPaidState = (balance <= 0 && grandTotal >= 0 && activeItems.length > 0);
                                 const isOrderConfirmed = checkedOrders?.has(nick) || false;

                                 const isEditingShipping = editingShippingNick === nick;
                                 const depositorName = depositorNames[nick];
                                 const addr = findAddress(nick);
                                 const suggestions = findAddressSuggestions(nick);

                                 let borderClass = 'border-transparent';
                                 let headerBgClass = 'bg-white';

                                 if (isCard) {
                                     borderClass = 'border-purple-200 ring-1 ring-purple-200'; 
                                     headerBgClass = 'bg-purple-50'; 
                                 } else if (!isPaidState && balance > 0) { 
                                     borderClass = 'border-red-200 ring-1 ring-red-200';
                                     headerBgClass = 'bg-red-50'; 
                                 } else if (balance < 0 && !isCard) { 
                                     borderClass = 'border-blue-200 ring-1 ring-blue-200';
                                     headerBgClass = 'bg-blue-50'; 
                                 } else if (isPaidState) { 
                                     borderClass = 'border-gray-200'; 
                                     headerBgClass = 'bg-white'; 
                                 } 
                                 
                                 if (isSelected) {
                                     headerBgClass = 'bg-indigo-50';
                                     borderClass = 'border-indigo-400 ring-1 ring-indigo-400 shadow-md';
                                 }

                                 return (<div key={nick} onClick={() => setSelectedNick(prev => prev === nick ? null : nick)} className={`bg-white rounded shadow-sm transition-all overflow-hidden cursor-pointer ${borderClass} border`}>
                                    <div className={`px-2 py-1.5 flex justify-between items-center border-b border-gray-100 ${headerBgClass}`}>
                                     <div className="flex flex-col gap-0.5">
                                         <div className="flex items-center gap-2">
                                            <span className={`font-bold text-sm text-gray-900`}>{nick}</span>
                                            {renderSpecialBadge(nick)}
                                            
                                            <button onClick={(e) => { e.stopPropagation(); addOrderLogic(nick, '', 1); }} className="bg-indigo-100 text-indigo-700 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold hover:bg-indigo-200" title="ë¹ˆ ìƒí’ˆì¤„ ì¶”ê°€">+</button>
                                            <button onClick={(e)=>{e.stopPropagation(); handleNicknameEdit(nick);}} className="text-gray-300 hover:text-indigo-600" title="ë‹‰ë„¤ì„ ìˆ˜ì •"><Icon name="pencil-simple" weight="bold" size={12}/></button>
                                            <button onClick={(e) => { e.stopPropagation(); toggleCardPayment(nick); }} className={`ml-1 text-[10px] px-1.5 py-0.5 rounded border transition-colors ${isCard ? 'bg-purple-100 border-purple-300 text-purple-700 font-bold' : 'bg-white text-gray-400 hover:bg-gray-100'}`}>ì¹´ë“œ</button>
                                            
                                            <div onClick={(e) => e.stopPropagation()} className="ml-1">
                                                {isEditingShipping ? (
                                                    <div className="flex items-center gap-1 bg-white border border-indigo-300 rounded px-1 py-0.5 shadow-sm"><Icon name="truck" className="text-indigo-600 text-[10px]"/><input type="number" value={currentShipping} onChange={(e) => handleShippingChange(nick, e.target.value)} onBlur={() => setEditingShippingNick(null)} onKeyDown={(e) => { if(e.key === 'Enter') setEditingShippingNick(null); }} autoFocus onFocus={(e) => e.target.select()} className="w-12 text-[10px] outline-none font-mono text-right text-indigo-600 font-bold bg-transparent"/></div>
                                                ) : (
                                                    <div onClick={() => setEditingShippingNick(nick)} className="cursor-pointer flex items-center gap-1 text-[10px] text-gray-500 bg-white px-1.5 py-0.5 rounded border hover:bg-indigo-50 hover:text-indigo-600 transition-colors" title="í´ë¦­í•˜ì—¬ ë°°ì†¡ë¹„ ìˆ˜ì •">
                                                        <Icon name="truck" weight="fill"/> <span>{currentShipping.toLocaleString()}</span>
                                                    </div>
                                                )}
                                            </div>

                                            <div onClick={(e) => { e.stopPropagation(); openModal(`'${nick}'ë‹˜ì˜ ì…ê¸ˆìëª…(ì‹¤ëª…)ì„ ì…ë ¥í•˜ì„¸ìš”.`, 'prompt', (newName) => { if(newName !== null) setDepositorNames(prev => ({...prev, [nick]: newName})); }, null, depositorName || ''); }} className={`cursor-pointer flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded border hover:bg-indigo-50 transition-colors ml-1 ${depositorName ? 'bg-indigo-50 text-indigo-600 border-indigo-200' : 'bg-white text-gray-400'}`} title="ì‹¤ëª… ì…ê¸ˆì ë“±ë¡">
                                                <Icon name="user" weight={depositorName ? "fill" : "regular"}/> <span>{depositorName || 'ì…ê¸ˆì'}</span>
                                            </div>

                                            <div onClick={(e) => { e.stopPropagation(); handleFullDepositToggle(nick, grandTotal, depositTotal); }} className={`cursor-pointer ml-1 flex items-center gap-1 px-1.5 py-0.5 rounded border transition-colors ${isPaidState ? 'bg-green-500 border-green-600 text-white shadow-inner' : 'bg-white border-gray-200 text-gray-400 hover:bg-gray-100'}`} title={isPaidState ? "ì…ê¸ˆ ì™„ë£Œë¨ (í´ë¦­ì‹œ ì·¨ì†Œ)" : "í´ë¦­ì‹œ ì „ì•¡ ì…ê¸ˆ ì²˜ë¦¬"}>
                                                <Icon name={isPaidState ? "toggle-right" : "toggle-left"} weight="fill" size={16} />
                                                <span className="text-[10px] font-bold">{isPaidState ? "ì™„ë‚©" : "ë¯¸ë‚©"}</span>
                                            </div>

                                            <button 
                                                onClick={(e) => { e.stopPropagation(); copyOrderSheet(nick, items, grandTotal, depositTotal, balance, isCard); }} 
                                                className={`ml-1 flex items-center gap-1 px-2 py-0.5 rounded border transition-colors ${copyStatus[nick] ? 'bg-green-100 border-green-300 text-green-700' : 'bg-yellow-300 border-yellow-400 text-yellow-900 hover:bg-yellow-400'}`}
                                                title="ì£¼ë¬¸ì„œ ì¹´í†¡ ë³µì‚¬"
                                            >
                                                <Icon name={copyStatus[nick] ? "check" : "chat-circle-dots"} weight="fill" size={16}/>
                                                <span className="text-[10px] font-bold">ì¹´í†¡</span>
                                            </button>

                                            <div onClick={(e) => { e.stopPropagation(); handleOrderCheckToggle(nick); }} className="ml-1 cursor-pointer flex items-center" title="ì£¼ë¬¸ í™•ì¸ ì²´í¬">
                                                <input type="checkbox" checked={isOrderConfirmed} readOnly className="custom-checkbox" />
                                            </div>
                                         </div>
                                         <div className="flex flex-col items-start gap-1 text-xs mt-1">
                                             {addr ? (
                                                 <span className="text-green-600 text-[10px] flex items-center gap-1">
                                                     <Icon name="house-line" weight="fill"/> {addr.realname} ({addr.phone})
                                                     {addressMapping[nick] && <button onClick={(e) => {e.stopPropagation(); handleAddressUnmapping(nick);}} className="text-gray-400 hover:text-red-500 ml-1" title="ì£¼ì†Œ ì—°ê²° í•´ì œ"><Icon name="link-break" weight="bold"/></button>}
                                                 </span>
                                             ) : (
                                                 <div className="flex items-center gap-1">
                                                    <span className="text-red-300 text-[10px] flex items-center gap-1"><Icon name="warning-circle" weight="fill"/> ì£¼ì†Œì—†ìŒ</span>
                                                    <button onClick={(e) => { e.stopPropagation(); openModal("ì—°ê²°í•  ì£¼ì†Œë¡ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.", "prompt", (targetNick) => { if(targetNick) handleAddressMapping(nick, targetNick); }); }} className="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded border border-gray-300 hover:bg-gray-200 flex items-center gap-1"><Icon name="link" weight="bold" /> ì—°ê²°</button>
                                                    {suggestions.length > 0 && (<div className="flex flex-wrap gap-1 items-center bg-orange-50 px-1 py-0.5 rounded"><span className="text-[9px] text-orange-600 font-bold">ìœ ì‚¬:</span>{suggestions.map(s => (<button key={s} onClick={(e) => {e.stopPropagation(); handleAddressMapping(nick, s);}} className="bg-white border border-orange-200 text-orange-700 px-1.5 py-0.5 rounded text-[9px] hover:bg-orange-100 transition-colors shadow-sm">{s}</button>))}</div>)}
                                                 </div>
                                             )}
                                         </div>
                                     </div>
                                     <div className="flex flex-col gap-1 items-end text-right">
                                        <div className={`font-bold text-sm font-mono ${isPaidState && balance === 0 ? 'text-green-600' : (balance < 0 ? 'text-blue-600' : 'text-gray-800')}`}>{grandTotal.toLocaleString()}ì›</div>
                                        {!isCard && balance !== 0 && depositTotal > 0 && (<div className="text-[10px] text-gray-500">(ì…ê¸ˆ: {depositTotal.toLocaleString()}ì›)</div>)}
                                        {!isCard && balance > 0 && (<div className="text-[10px] font-bold text-red-500 mt-0.5">ë¯¸ë‚©: {balance.toLocaleString()}ì›</div>)}
                                        {!isCard && balance < 0 && (<div className="text-[10px] font-bold text-blue-600 mt-0.5">ê³¼ë‚©: {Math.abs(balance).toLocaleString()}ì›</div>)}
                                     </div>
                                 </div>
                                 
                                 <div className="p-1 space-y-1 bg-white">
                                    {items.map((item, idx) => { 
                                        const isZeroPrice = Number(item.price) === 0; 
                                        const invInfo = inventory && inventory[item.product]; 
                                        let stockBadge = null; 
                                        if (invInfo) { 
                                            const totalOrdered = orders.filter(o => o.product === item.product && !o.isCancelled).reduce((sum, o) => sum + o.quantity, 0); 
                                            const remaining = invInfo.stock - totalOrdered; 
                                            if (remaining < 0) stockBadge = <span className="text-red-500 font-bold text-[10px] ml-1 animate-pulse">(ì¬ê³ ì´ˆê³¼ {remaining})</span>; 
                                            else if (remaining === 0) stockBadge = <span className="text-red-500 font-bold text-[10px] ml-1">(í’ˆì ˆ)</span>; 
                                            else if (remaining <= 2) stockBadge = <span className="text-orange-500 font-bold text-[10px] ml-1">(ë§ˆê°ì„ë°• {remaining})</span>; 
                                        } 

                                        return (
                                            <div key={idx} className={`flex justify-between items-center text-xs p-1 rounded group transition-colors ${item.isCancelled ? 'bg-red-50/80 border border-red-100' : 'hover:bg-gray-50'}`}>
                                                <div className="flex-1 flex gap-1 items-center">
                                                    {item.isCancelled && <span className="text-[9px] text-red-500 font-bold shrink-0">[ì·¨ì†Œ]</span>}
                                                    <input 
                                                        type="text" 
                                                        list="product-list" 
                                                        value={item.product} 
                                                        onChange={(e) => handleProductChange(item.id, 'product', e.target.value)} 
                                                        onClick={(e) => e.stopPropagation()} 
                                                        onFocus={(e) => e.target.select()}
                                                        className={`w-full outline-none px-1 rounded transition-colors ${item.isCancelled ? 'text-gray-400 line-through bg-transparent' : (item.isUnmodified ? 'text-blue-600 font-bold bg-blue-50 focus:bg-white focus:ring-1 focus:ring-blue-300' : 'bg-transparent focus:bg-white focus:ring-1 focus:ring-indigo-100')}`} 
                                                        placeholder="ìƒí’ˆëª…" 
                                                        disabled={item.isCancelled} 
                                                    />
                                                    {stockBadge}
                                                </div>
                                                <div className="flex items-center gap-1">
                                                    <span onDoubleClick={(e) => { e.stopPropagation(); if (!item.isCancelled) setEditingQuantityId(item.id); }} className={`cursor-pointer font-bold ${item.isCancelled ? 'cursor-not-allowed hover:bg-transparent line-through text-gray-400' : (item.isUnmodified ? 'text-blue-600 hover:bg-blue-100' : 'text-indigo-600 hover:bg-indigo-100')}`}>
                                                        {editingQuantityId === item.id ? (<input type="number" defaultValue={item.quantity} autoFocus onFocus={(e) => e.target.select()} className="w-8 text-center text-[10px] font-bold text-indigo-600 bg-white border border-indigo-300 rounded outline-none" onBlur={(e) => handleQuantityUpdate(item.id, e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') handleQuantityUpdate(item.id, e.currentTarget.value); }} onClick={(e) => e.stopPropagation()} />) : `${item.quantity}ê°œ`}
                                                    </span>
                                                    <input type="number" value={item.price} onChange={(e) => handleProductChange(item.id, 'price', e.target.value)} onClick={(e) => e.stopPropagation()} onFocus={(e) => e.target.select()} className={`w-14 text-right font-mono bg-transparent outline-none ${item.isCancelled ? 'line-through text-gray-400' : (item.isUnmodified ? 'text-blue-500 font-bold' : 'text-gray-500 focus:text-indigo-600')} ${Number(item.price) === 0 && !item.isCancelled ? 'bg-red-50 border-b border-red-300' : ''}`} disabled={item.isCancelled} />
                                                    <button onClick={(e)=>{e.stopPropagation(); handleOrderCancel(item.id);}} className={`ml-1 ${item.isCancelled ? "text-blue-500 hover:text-blue-700" : "text-gray-300 hover:text-red-500"}`} title={item.isCancelled ? "ì·¨ì†Œ ì² íšŒ" : "ì£¼ë¬¸ ì·¨ì†Œ"}><Icon name={item.isCancelled ? "arrow-u-up-left" : "prohibit"} weight="bold"/></button>
                                                    <button onClick={(e)=>{e.stopPropagation(); handleOrderDelete(item.id);}} className="text-gray-300 hover:text-red-500 ml-1"><Icon name="trash" weight="bold"/></button>
                                                </div>
                                            </div>
                                        ); 
                                    })}
                                </div>
                            </div>
                        );
                        })}
                        </div>
                    </div>
                </div>
             );
        };
        
        const OrderStatusTab = ({ orders, setOrders, setProductHistory, productHistory, inventory, setInventory }) => {
            const [expandedProduct, setExpandedProduct] = useState(null);
            const [newProdName, setNewProdName] = useState('');
            const [newProdStock, setNewProdStock] = useState('');
            const [newProdPrice, setNewProdPrice] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);

            const handleAddInventory = () => { if(!newProdName.trim()) return alert("ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”."); if(inventory && inventory[newProdName] && !confirm("ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; setInventory(prev => ({ ...prev, [newProdName]: { stock: Number(newProdStock) || 0, price: Number(newProdPrice) || 0 } })); if(newProdPrice) setProductHistory(prev => ({ ...prev, [newProdName]: Number(newProdPrice) })); setNewProdName(''); setNewProdStock(''); setNewProdPrice(''); };
            const handleClearInventory = () => { if(confirm("ëª¨ë“  ì¬ê³  ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) setInventory({}); };
            const productStats = useMemo(() => { const stats = {}; if(inventory) { Object.entries(inventory).forEach(([name, info]) => { if (!info) return; stats[name] = { totalQty: 0, customers: [], unitPrice: Number(info.price) || 0, initStock: Number(info.stock) || 0, remaining: Number(info.stock) || 0, paidQty: 0, unpaidQty: 0 }; }); } if (orders) { const customerPaidStatus = {}; const customerGroups = {}; orders.forEach(o => { if(!customerGroups[o.customer]) customerGroups[o.customer] = []; customerGroups[o.customer].push(o); }); const savedCardPayments = JSON.parse(localStorage.getItem('cardPayments')) || {}; const savedShippingOverrides = JSON.parse(localStorage.getItem('shippingOverrides')) || {}; Object.entries(customerGroups).forEach(([nick, items]) => { const activeItems = items.filter(i => !i.isCancelled); if(activeItems.length === 0) { customerPaidStatus[nick] = false; return; } const isCard = savedCardPayments[nick]; const shipping = savedShippingOverrides[nick] !== undefined ? savedShippingOverrides[nick] : 4000; const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0); const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0); const grandTotal = productTotal + shipping; customerPaidStatus[nick] = (depositTotal >= grandTotal) || isCard; }); orders.filter(o => !o.isCancelled).forEach(o => { const prodName = o.product || '(ìƒí’ˆëª… ì—†ìŒ)'; if (!stats[prodName]) { let uPrice = Number(productHistory[prodName]) || 0; if(uPrice === 0 && o.quantity > 0) uPrice = o.price / o.quantity; stats[prodName] = { totalQty: 0, customers: [], unitPrice: uPrice, initStock: 0, remaining: 0, paidQty: 0, unpaidQty: 0 }; } stats[prodName].totalQty += o.quantity; stats[prodName].customers.push({ nick: o.customer, qty: o.quantity }); if (customerPaidStatus[o.customer]) stats[prodName].paidQty += o.quantity; else stats[prodName].unpaidQty += o.quantity; if(stats[prodName].initStock > 0) stats[prodName].remaining = stats[prodName].initStock - stats[prodName].totalQty; else stats[prodName].remaining = -stats[prodName].totalQty; }); } return Object.entries(stats).sort((a, b) => a[0].localeCompare(b[0], 'ko', { numeric: true })); }, [orders, productHistory, inventory]);
            const handleDownloadExcel = () => { let data = []; productStats.forEach(([product, info]) => { data.push({ 'ìƒí’ˆëª…': `ğŸ“¦ ${product}`, 'ì…ê¸ˆì™„ë£Œ ìˆ˜ëŸ‰': info.paidQty || '', 'ë¯¸ì…ê¸ˆ(ë…¸ì‡¼) ìˆ˜ëŸ‰': info.unpaidQty || '' }); }); downloadExcel(data, 'ë°œì£¼í˜„í™©_ìƒì„¸(ì…ê¸ˆêµ¬ë¶„)'); };
            const handleEditProductName = (oldName) => { const newName = prompt("ìƒˆ ìƒí’ˆëª… ì…ë ¥", oldName); if (newName && newName !== oldName) { if (confirm("ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { setOrders(prev => prev.map(o => o.product === oldName ? { ...o, product: newName } : o)); if(inventory[oldName]) { setInventory(prev => { const next = { ...prev }; next[newName] = next[oldName]; delete next[oldName]; return next; }); } setProductHistory(prev => { const next = { ...prev }; if (next[oldName]) { next[newName] = next[oldName]; delete next[oldName]; } return next; }); } } };
            const handleEditProductPrice = (prodName, currentPrice) => { const newPriceStr = prompt("ìƒˆ ë‹¨ê°€ ì…ë ¥", currentPrice); if (newPriceStr !== null) { const newPrice = parseInt(newPriceStr.replace(/[^0-9]/g, ''), 10); if (!isNaN(newPrice)) { if (confirm("ë‹¨ê°€ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { setOrders(prev => prev.map(o => { if (o.product === prodName && !o.isCancelled) { return { ...o, price: newPrice * o.quantity }; } return o; })); if(inventory[prodName]) { setInventory(prev => ({ ...prev, [prodName]: { ...prev[prodName], price: newPrice } })); } setProductHistory(prev => ({ ...prev, [prodName]: newPrice })); } } } };
            const handleEditStock = (prodName, currentStock) => { const newStockStr = prompt("ìˆ˜ëŸ‰ ì…ë ¥", currentStock); if(newStockStr !== null) { const newStock = parseInt(newStockStr, 10); if(!isNaN(newStock)) { setInventory(prev => ({ ...prev, [prodName]: { ...prev[prodName], stock: newStock } })); } } };
            const handleDeleteInventory = (prodName) => { if(confirm("ì¬ê³  ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { setInventory(prev => { const next = { ...prev }; delete next[prodName]; return next; }); } };
            const handleInventoryUpload = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { try { const wb = XLSX.read(evt.target.result, { type: 'binary' }); const ws = wb.Sheets[wb.SheetNames[0]]; const data = XLSX.utils.sheet_to_json(ws, { header: 1 }); const newInventory = { ...inventory }; const newHistory = { ...productHistory }; let count = 0; for (let i = 1; i < data.length; i++) { const row = data[i]; if (!row[0]) continue; const name = String(row[0]).trim(); const stock = parseInt(row[1]) || 0; const price = parseInt(row[2]) || 0; newInventory[name] = { stock, price: price > 0 ? price : (newInventory[name]?.price || 0) }; if (price > 0) newHistory[name] = price; count++; } setInventory(newInventory); setProductHistory(newHistory); alert(`${count}ê±´ ë“±ë¡ë¨`); } catch (err) { alert("ì˜¤ë¥˜: " + err.message); } }; reader.readAsBinaryString(file); e.target.value = ''; };
            
            const filteredProductStats = useMemo(() => { if (!searchTerm) return productStats; return productStats.filter(([product]) => product.toLowerCase().includes(searchTerm.toLowerCase())); }, [productStats, searchTerm]);

            return (
                <div className="flex flex-col h-full bg-white rounded-lg shadow-sm border p-4 overflow-hidden">
                    <div className="flex justify-between items-center mb-4 pb-4 border-b"><h2 className="text-xl font-bold flex items-center gap-2"><Icon name="clipboard-text" weight="fill" className="text-indigo-600"/> ì¬ê³ /ë°œì£¼ í˜„í™© <span className="text-sm font-normal text-gray-500">({productStats.length}ì¢…)</span></h2><div className="flex gap-2"><button onClick={handleClearInventory} className="bg-red-500 text-white px-3 py-1.5 rounded text-sm font-bold shadow-sm">ì¬ê³ ì „ì²´ì‚­ì œ</button><input type="file" ref={fileInputRef} onChange={handleInventoryUpload} className="hidden" /><button onClick={() => fileInputRef.current.click()} className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-bold shadow-sm"><Icon name="file-arrow-up" weight="fill"/> ì—…ë¡œë“œ</button><button onClick={handleDownloadExcel} className="bg-green-600 text-white px-3 py-1.5 rounded text-sm font-bold shadow-sm"><Icon name="file-xls" weight="fill"/> ë‹¤ìš´ë¡œë“œ</button></div></div>
                    <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-4 flex gap-2 items-center"><input type="text" placeholder="ìƒí’ˆëª…" value={newProdName} onChange={e=>setNewProdName(e.target.value)} className="flex-1 border rounded px-2 py-1.5 text-sm" /><input type="number" placeholder="ìˆ˜ëŸ‰" value={newProdStock} onChange={e=>setNewProdStock(e.target.value)} className="w-20 border rounded px-2 py-1.5 text-sm" /><input type="number" placeholder="ë‹¨ê°€" value={newProdPrice} onChange={e=>setNewProdPrice(e.target.value)} className="w-24 border rounded px-2 py-1.5 text-sm" /><button onClick={handleAddInventory} className="bg-indigo-600 text-white px-4 py-1.5 rounded font-bold text-sm shadow-sm">ë“±ë¡</button></div>
                    <div className="relative mb-2"><Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/><input type="text" placeholder="ìƒí’ˆëª… ê²€ìƒ‰..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-10 border rounded py-2 text-sm outline-none focus:border-indigo-500" />{searchTerm && (<button onClick={() => setSearchTerm('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={14}/></button>)}</div>
                    <div className="flex-1 overflow-y-auto">{productStats.length === 0 ? <div className="flex flex-col items-center justify-center h-full text-gray-400"><p>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p></div> : productStats.map(([product, info]) => { const isSoldOut = info.initStock > 0 && info.remaining <= 0; return (<div key={product} className={`border-b last:border-0 ${isSoldOut ? 'bg-red-50' : ''}`}><div className="flex justify-between items-center p-3 hover:bg-indigo-50 transition-colors"><div className="flex-1 flex items-center gap-2"><div className="cursor-pointer font-bold text-gray-700 text-sm flex items-center gap-1 hover:text-indigo-600" onClick={() => handleEditProductName(product)}>{product}<Icon name="pencil-simple" size={12} className="text-gray-300"/></div>{info.initStock > 0 ? (<span className={`cursor-pointer px-2 py-0.5 rounded font-bold text-xs ${isSoldOut ? 'bg-red-500 text-white' : 'bg-green-100 text-green-700'}`} onClick={() => handleEditStock(product, info.initStock)}>{isSoldOut ? 'í’ˆì ˆ' : `ì”ì—¬ ${info.remaining}`} / {info.initStock}</span>) : (<span className="cursor-pointer bg-gray-100 text-gray-400 px-2 py-0.5 rounded text-xs" onClick={() => handleEditStock(product, 0)}>ë¯¸ì„¤ì •</span>)}<div className="text-gray-400 cursor-pointer" onClick={() => setExpandedProduct(expandedProduct === product ? null : product)}><Icon name={expandedProduct === product ? "caret-up" : "caret-down"}/></div></div><div className="flex items-center gap-2"><button onClick={() => handleEditProductPrice(product, info.unitPrice)} className="flex items-center gap-1 bg-white border border-gray-200 px-2 py-0.5 rounded text-xs shadow-sm"><Icon name="currency-krw" weight="bold" size={10}/><span className="font-mono">{info.unitPrice.toLocaleString()}</span>ì›</button><span className="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold text-xs w-12 text-center">{info.totalQty}ê°œ</span><button onClick={() => handleDeleteInventory(product)} className="text-gray-300 hover:text-red-500 p-1"><Icon name="trash" weight="bold"/></button></div></div>{expandedProduct === product && (<div className="bg-gray-50 p-2 text-xs grid grid-cols-2 sm:grid-cols-3 gap-2 border-t border-gray-100">{info.customers.map((c, idx) => (<div key={idx} className="flex justify-between items-center bg-white p-2 rounded border border-gray-200 shadow-sm"><span className="text-gray-600 truncate mr-2" title={c.nick}>{c.nick}</span><span className="font-bold text-indigo-600 shrink-0">{c.qty}</span></div>))}</div>)}</div>)})}</div>
                </div>
            );
        };

        const CustomerTab = ({ addresses, setAddresses, googleScriptUrl, customerSheetId, openModal, specialCustomers, setSpecialCustomers }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);
            const [inputData, setInputData] = useState({ nickname: '', realname: '', phone: '', zipcode: '', address: '', memo: '' });
            const [inlineEditNick, setInlineEditNick] = useState(null);
            const [inlineEditData, setInlineEditData] = useState({});
            const [scInput, setScInput] = useState({ nickname: '', type: 'vip', memo: '' });
            const [scSearch, setScSearch] = useState('');

            const filteredAddresses = useMemo(() => { if (!searchTerm) return addresses; return addresses.filter(a => a.nickname.toLowerCase().includes(searchTerm.toLowerCase()) || a.realname.toLowerCase().includes(searchTerm.toLowerCase())); }, [addresses, searchTerm]);
            const filteredSpecial = useMemo(() => { const list = Object.entries(specialCustomers || {}).map(([nick, info]) => ({ nickname: nick, ...info })); if (!scSearch) return list; return list.filter(item => item.nickname.toLowerCase().includes(scSearch.toLowerCase())); }, [specialCustomers, scSearch]);

            const handleAdd = () => { if (!inputData.nickname) return openModal("ë‹‰ë„¤ì„ í•„ìˆ˜", 'alert'); setAddresses(prev => { const next = prev.filter(a => a.nickname !== inputData.nickname); return [...next, inputData]; }); setInputData({ nickname: '', realname: '', phone: '', zipcode: '', address: '', memo: '' }); };
            const handleDelete = (nickname) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) setAddresses(prev => prev.filter(a => a.nickname !== nickname)); };
            const handleAddressSearch = (setter) => { try { new window.daum.Postcode({ oncomplete: function(data) { let fullAddr = data.address; if(data.addressType === 'R'){ if(data.bname !== '') fullAddr += data.bname; if(data.buildingName !== '') fullAddr += ', ' + data.buildingName; } setter(prev => ({ ...prev, zipcode: data.zonecode, address: fullAddr })); } }).open(); } catch (e) { openModal("ì£¼ì†Œ ê²€ìƒ‰ ì˜¤ë¥˜", 'alert'); } };
            const startInlineEdit = (addr) => { setInlineEditNick(addr.nickname); setInlineEditData({...addr}); };
            const saveInlineEdit = () => { setAddresses(prev => prev.map(a => a.nickname === inlineEditNick ? inlineEditData : a)); setInlineEditNick(null); };
            const handleAddSpecial = () => { if (!scInput.nickname) return openModal("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'alert'); setSpecialCustomers(prev => ({ ...prev, [scInput.nickname]: { type: scInput.type, memo: scInput.memo } })); setScInput({ nickname: '', type: 'vip', memo: '' }); };
            const handleDeleteSpecial = (nick) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) setSpecialCustomers(prev => { const next = { ...prev }; delete next[nick]; return next; }); };
            const handleCloudSave = async () => { openModal("ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', async () => { if (!googleScriptUrl) return; await fetch(googleScriptUrl, { method: 'POST', body: JSON.stringify({ action: 'backup_address', data: addresses, sheet_id: customerSheetId }), mode: 'no-cors', headers: {'Content-Type': 'text/plain;charset=utf-8'} }); openModal("ì „ì†¡ ì™„ë£Œ", 'alert'); }); };
            const handleCloudLoad = async () => { openModal("ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', async () => { if (!googleScriptUrl) return; const res = await fetch(`${googleScriptUrl}?action=get_addresses&t=${Date.now()}&sheet_id=${customerSheetId}`); const data = await res.json(); if(data && data.addresses) setAddresses(data.addresses); openModal("ë¡œë“œ ì™„ë£Œ", 'alert'); }); };
            const handleExcelUpload = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { const wb = XLSX.read(evt.target.result, { type: 'binary' }); const ws = wb.Sheets[wb.SheetNames[0]]; const data = XLSX.utils.sheet_to_json(ws, { header: 1 }); const newAddrs = []; for(let i=1; i<data.length; i++) { if(data[i][0]) newAddrs.push({ nickname: data[i][0], realname: data[i][1]||'', phone: data[i][2]||'', zipcode: data[i][3]||'', address: data[i][4]||'', memo: data[i][5]||'' }); } setAddresses(prev => [...prev, ...newAddrs]); alert(`${newAddrs.length}ëª… ì¶”ê°€ë¨`); }; reader.readAsBinaryString(file); e.target.value = ''; };

             return (
                 <div className="flex h-full gap-4">
                     <div className="flex-1 flex flex-col bg-white rounded-lg shadow-sm border p-4 overflow-hidden">
                         <div className="flex justify-between items-center mb-4 pb-4 border-b"><h2 className="text-xl font-bold flex items-center gap-2"><Icon name="address-book" weight="fill" className="text-indigo-600"/> ë°°ì†¡ ì£¼ì†Œë¡ <span className="text-sm font-normal text-gray-500">({addresses.length}ëª…)</span></h2><div className="flex gap-2"><button onClick={handleCloudSave} className="bg-orange-500 text-white px-2 py-1 rounded text-xs font-bold">ì €ì¥</button><button onClick={handleCloudLoad} className="bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold">ë¡œë“œ</button><input type="file" ref={fileInputRef} onChange={handleExcelUpload} className="hidden" /><button onClick={()=>fileInputRef.current.click()} className="bg-green-600 text-white px-2 py-1 rounded text-xs font-bold">ì—‘ì…€</button></div></div>
                         <div className="bg-indigo-50 p-2 rounded-lg border border-indigo-100 mb-2 grid grid-cols-6 gap-2 items-end"><div className="col-span-1"><input type="text" value={inputData.nickname} onChange={e=>setInputData({...inputData, nickname:e.target.value})} className="w-full border rounded px-1 py-1 text-xs" placeholder="ë‹‰ë„¤ì„"/></div><div className="col-span-1"><input type="text" value={inputData.realname} onChange={e=>setInputData({...inputData, realname:e.target.value})} className="w-full border rounded px-1 py-1 text-xs" placeholder="ì´ë¦„"/></div><div className="col-span-1"><input type="text" value={inputData.phone} onChange={e=>setInputData({...inputData, phone:e.target.value})} className="w-full border rounded px-1 py-1 text-xs" placeholder="ì—°ë½ì²˜"/></div><div className="col-span-2 flex gap-1"><input type="text" value={inputData.address} onChange={e=>setInputData({...inputData, address:e.target.value})} className="flex-1 border rounded px-1 py-1 text-xs" placeholder="ì£¼ì†Œ"/><button onClick={()=>handleAddressSearch(setInputData)} className="bg-slate-500 text-white px-1 rounded text-[10px]">ê²€ìƒ‰</button></div><button onClick={handleAdd} className="bg-indigo-600 text-white px-2 py-1 rounded font-bold text-xs">ì¶”ê°€</button></div>
                         <input type="text" placeholder="ê²€ìƒ‰..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full border rounded px-2 py-1.5 text-xs mb-2 outline-none" />
                         <div className="flex-1 overflow-y-auto border rounded bg-white"><table className="w-full text-xs text-left"><thead className="bg-gray-100 text-gray-600 sticky top-0"><tr><th className="p-2 border-b w-24">ë‹‰ë„¤ì„</th><th className="p-2 border-b w-16">ì´ë¦„</th><th className="p-2 border-b w-24">ì—°ë½ì²˜</th><th className="p-2 border-b">ì£¼ì†Œ</th><th className="p-2 border-b w-10 text-center">ê´€ë¦¬</th></tr></thead><tbody className="divide-y">{filteredAddresses.map((addr, i) => (<tr key={i} className="hover:bg-gray-50" onDoubleClick={()=>startInlineEdit(addr)}>{inlineEditNick===addr.nickname?(<><td className="p-2"><input value={inlineEditData.nickname} onChange={e=>setInlineEditData({...inlineEditData, nickname:e.target.value})} className="w-full border rounded px-1 py-0.5"/></td><td className="p-2"><input value={inlineEditData.realname} onChange={e=>setInlineEditData({...inlineEditData, realname:e.target.value})} className="w-full border rounded px-1 py-0.5"/></td><td className="p-2"><input value={inlineEditData.phone} onChange={e=>setInlineEditData({...inlineEditData, phone:e.target.value})} className="w-full border rounded px-1 py-0.5"/></td><td className="p-2"><input value={inlineEditData.address} onChange={e=>setInlineEditData({...inlineEditData, address:e.target.value})} className="w-full border rounded px-1 py-0.5"/></td><td className="p-2 text-center"><button onClick={saveInlineEdit} className="text-blue-500"><Icon name="check" weight="bold"/></button></td></>):(<><td className="p-2 font-bold text-indigo-700">{addr.nickname}</td><td className="p-2">{addr.realname}</td><td className="p-2">{addr.phone}</td><td className="p-2 text-gray-600 truncate max-w-xs">{addr.address}</td><td className="p-2 text-center"><button onClick={()=>handleDelete(addr.nickname)} className="text-red-400 hover:text-red-600"><Icon name="trash" weight="fill"/></button></td></>)}</tr>))}</tbody></table></div>
                     </div>
                     <div className="w-[30%] flex flex-col bg-white rounded-lg shadow-sm border p-4 overflow-hidden border-l-4 border-l-orange-200">
                         <h2 className="text-lg font-bold mb-4 text-orange-800"><Icon name="crown" weight="fill" className="text-yellow-500"/> VIP / ì§„ìƒ ê´€ë¦¬</h2>
                         <div className="bg-orange-50 p-3 rounded-lg border border-orange-100 mb-4 flex flex-col gap-2"><div className="flex gap-2"><input type="text" placeholder="ë‹‰ë„¤ì„" value={scInput.nickname} onChange={e=>setScInput({...scInput, nickname: e.target.value})} className="flex-1 border rounded px-2 py-1.5 text-sm" /><select value={scInput.type} onChange={e=>setScInput({...scInput, type: e.target.value})} className="border rounded px-2 py-1.5 text-sm"><option value="vip">ğŸ‘‘ VIP</option><option value="black">ğŸš« ì§„ìƒ</option><option value="manager">ğŸ›¡ï¸ ê´€ë¦¬ì</option></select></div><input type="text" placeholder="ë©”ëª¨" value={scInput.memo} onChange={e=>setScInput({...scInput, memo: e.target.value})} className="w-full border rounded px-2 py-1.5 text-sm" /><button onClick={handleAddSpecial} className="w-full bg-orange-600 hover:bg-orange-700 text-white py-1.5 rounded font-bold text-sm shadow-sm">ë“±ë¡í•˜ê¸°</button></div>
                         <input type="text" placeholder="ê²€ìƒ‰..." value={scSearch} onChange={e=>setScSearch(e.target.value)} className="w-full border rounded px-2 py-1.5 text-sm mb-2 outline-none" />
                         <div className="flex-1 overflow-y-auto border rounded bg-white"><ul className="divide-y">{filteredSpecial.map((item, i) => (<li key={i} className="p-3 flex justify-between items-center hover:bg-orange-50"><div><div className="flex items-center gap-2 mb-1"><span className={`px-1.5 rounded text-[10px] font-bold ${item.type==='vip'?'bg-yellow-300 text-yellow-900':item.type==='black'?'bg-red-100 text-red-700':'bg-emerald-100 text-emerald-700'}`}>{item.type==='vip'?'ğŸ‘‘ VIP':item.type==='black'?'ğŸš« ì§„ìƒ':'ğŸ›¡ï¸ ê´€ë¦¬ì'}</span><span className="font-bold text-sm text-gray-800">{item.nickname}</span></div><div className="text-xs text-gray-500">{item.memo}</div></div><button onClick={()=>handleDeleteSpecial(item.nickname)} className="text-gray-300 hover:text-red-500 p-1"><Icon name="trash" weight="fill"/></button></li>))}</ul></div>
                     </div>
                 </div>
             );
        };
        const CSTab = ({ csData, setCsData, openModal }) => { 
            const [newNick, setNewNick] = useState(''); 
            const [newContent, setNewContent] = useState(''); 
            const addCS = (e) => { e.preventDefault(); if (!newNick) return; const newItem = { id: Date.now(), date: new Date().toISOString(), nickname: newNick, content: newContent, isResolved: false }; setCsData([newItem, ...csData]); setNewNick(''); setNewContent(''); }; 
            const updateCS = (id, field, value) => { setCsData(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item)); }; 
            const deleteCS = (id) => { openModal('ì´ CS ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'confirm', () => setCsData(prev => prev.filter(i => i.id !== id))); }; 
            return ( <div className="flex flex-col h-full bg-white rounded-lg shadow-sm border p-4 overflow-hidden"> <div className="flex justify-between items-center mb-4 pb-4 border-b"><h2 className="text-xl font-bold flex items-center gap-2"><Icon name="headset" weight="fill" className="text-indigo-600"/> CS ê´€ë¦¬ <span className="text-sm font-normal text-gray-500">({csData.length}ê±´)</span></h2></div> <form onSubmit={addCS} className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-4 flex gap-2 items-center"><input type="text" value={newNick} onChange={e=>setNewNick(e.target.value)} className="w-32 border rounded px-2 py-2 text-sm" placeholder="ë‹‰ë„¤ì„" /><input type="text" value={newContent} onChange={e=>setNewContent(e.target.value)} className="flex-1 border rounded px-2 py-2 text-sm" placeholder="ìƒë‹´ ë‚´ìš© ì…ë ¥..." /><button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-indigo-700">ë“±ë¡</button></form> <div className="flex-1 overflow-y-auto border rounded bg-white"> <table className="w-full text-sm text-left"><thead className="bg-gray-100 text-gray-600 sticky top-0"><tr><th className="p-2 border-b w-24">ë‚ ì§œ</th><th className="p-2 border-b w-32">ë‹‰ë„¤ì„</th><th className="p-2 border-b">ë‚´ìš©</th><th className="p-2 border-b w-16 text-center">ì™„ë£Œ</th><th className="p-2 border-b w-16 text-center">ì‚­ì œ</th></tr></thead> <tbody className="divide-y"> {csData.map(item => ( <tr key={item.id} className={`group hover:bg-gray-50 ${item.isResolved ? 'bg-gray-50 opacity-60' : ''}`}> <td className="p-2 text-xs text-gray-400">{new Date(item.date).toLocaleDateString()}</td> <td className="p-2"><input type="text" value={item.nickname} onChange={e=>updateCS(item.id, 'nickname', e.target.value)} className="w-full bg-transparent outline-none focus:bg-white focus:ring-1 ring-indigo-300 rounded px-1" /></td> <td className="p-2"><input type="text" value={item.content} onChange={e=>updateCS(item.id, 'content', e.target.value)} className={`w-full bg-transparent outline-none focus:bg-white focus:ring-1 ring-indigo-300 rounded px-1 ${item.isResolved ? 'line-through text-gray-400' : ''}`} /></td> <td className="p-2 text-center"><input type="checkbox" checked={item.isResolved} onChange={e=>updateCS(item.id, 'isResolved', e.target.checked)} className="cursor-pointer" /></td> <td className="p-2 text-center"><button onClick={()=>deleteCS(item.id)} className="text-gray-300 hover:text-red-500"><Icon name="trash" weight="bold"/></button></td> </tr> ))} </tbody> </table> </div> </div> ); 
        };

        const OrderManagementTab = ({ orders, shippingOverrides, quickShipping, addresses, handleExportBackup, handleImportBackup, addressMapping, cardPayments }) => {
            const findAddress = (nick) => {
                if (addressMapping[nick]) return addresses.find(a => normalizeString(a.nickname) === normalizeString(addressMapping[nick]));
                return addresses.find(a => normalizeString(a.nickname) === normalizeString(nick));
            };

            const handleExportProducts = () => { 
                const summary = {}; 
                const unpaidSummary = {}; 
                const paidSummary = {};   
                const customerPaidStatus = {};
                const customerGroups = {};
                orders.forEach(o => { if(!customerGroups[o.customer]) customerGroups[o.customer] = []; customerGroups[o.customer].push(o); });
                const savedCardPayments = cardPayments || {};
                const savedShippingOverrides = shippingOverrides || {};

                Object.entries(customerGroups).forEach(([nick, items]) => {
                    const activeItems = items.filter(i => !i.isCancelled);
                    if(activeItems.length === 0) { customerPaidStatus[nick] = false; return; }
                    const isCard = savedCardPayments[nick];
                    const shipping = savedShippingOverrides[nick] !== undefined ? savedShippingOverrides[nick] : quickShipping;
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + shipping;
                    customerPaidStatus[nick] = (depositTotal >= grandTotal) || isCard;
                });

                orders.forEach(o => { 
                    if(o.isCancelled) return; 
                    const name = o.product || '(ìƒí’ˆëª… ì—†ìŒ)'; 
                    if (!summary[name]) summary[name] = 0; 
                    if (!paidSummary[name]) paidSummary[name] = 0;
                    if (!unpaidSummary[name]) unpaidSummary[name] = 0;
                    summary[name] += Number(o.quantity); 
                    if (customerPaidStatus[o.customer]) paidSummary[name] += Number(o.quantity);
                    else unpaidSummary[name] += Number(o.quantity);
                }); 
                
                const sortedKeys = Object.keys(summary).sort((a, b) => a.localeCompare(b, 'ko', { numeric: true }));
                const data = sortedKeys.map(product => ({ 'ìƒí’ˆëª…': product, 'ì…ê¸ˆì™„ë£Œ ìˆ˜ëŸ‰': paidSummary[product] || 0, 'ë¯¸ì…ê¸ˆ(ë…¸ì‡¼) ìˆ˜ëŸ‰': unpaidSummary[product] || 0 })); 
                downloadExcel(data, 'ìƒí’ˆë³„_ë°œì£¼ë¦¬ìŠ¤íŠ¸'); 
            };

            const handleExportCustomers = () => { 
                const groups = {}; 
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); }); 
                let entries = Object.entries(groups).map(([nick, items]) => {
                    const activeItems = items.filter(i => !i.isCancelled);
                    const isCard = cardPayments[nick]; 
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping); 
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0); 
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0); 
                    const grandTotal = productTotal + currentShipping; 
                    const isPaid = (depositTotal >= grandTotal) || isCard;
                    return { nick, items: activeItems, isPaid, depositTotal, grandTotal };
                });

                entries.sort((a, b) => {
                    if (a.isPaid === b.isPaid) return a.nick.localeCompare(b.nick);
                    return a.isPaid ? -1 : 1; 
                });

                let excelRows = []; 
                entries.forEach(({ nick, items, isPaid }) => { 
                    if(items.length === 0) return; 
                    const addrInfo = findAddress(nick) || {}; 
                    const fullAddress = addrInfo.zipcode ? `(${addrInfo.zipcode}) ${addrInfo.address || ''}` : (addrInfo.address || ''); 
                    
                    const statusColumn = isPaid ? "" : "ë¯¸ì…ê¸ˆ";
                    const createRow = (productValue) => ({ 'ë‚ ì§œì‹œê°„': new Date().toLocaleString(), 'ê³µë€1': '', 'ì…ê¸ˆìƒíƒœ': statusColumn, 'ë‹‰ë„¤ì„': nick, 'ì£¼ë¬¸ì œí’ˆ(ìˆ˜ëŸ‰)': productValue, 'ì´ë¦„': addrInfo.realname || '', 'í•¸ë“œí°ë²ˆí˜¸': addrInfo.phone || '', 'ì£¼ì†Œ': fullAddress, 'ë°°ì†¡ë©”ëª¨': addrInfo.memo || '' }); 
                    excelRows.push(createRow(`[ ${nick} ]`)); 
                    items.forEach(item => { const qtyPart = item.quantity > 1 ? ` â˜… ${item.quantity}ê°œ` : ''; excelRows.push(createRow(`${item.product}${qtyPart}`)); }); 
                }); 
                downloadExcel(excelRows, 'ê³ ê°ë³„_ì •ì‚°_ë°°ì†¡ë¦¬ìŠ¤íŠ¸'); 
            };

            const handleExportUnpaid = () => {
                const groups = {}; 
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                
                const data = [];
                Object.entries(groups).forEach(([nick, items]) => {
                    if (cardPayments && cardPayments[nick]) return; 
                    
                    const activeItems = items.filter(i => !i.isCancelled);
                    if (activeItems.length === 0) return;
                    
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const grandTotal = productTotal + currentShipping;
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const balance = grandTotal - depositTotal;
                    
                    if (balance > 0) { 
                        const depositStatus = depositTotal > 0 ? `ë¶€ë¶„ì…ê¸ˆ(${depositTotal.toLocaleString()}ì›)` : 'ë¯¸ì…ê¸ˆ';
                        
                        activeItems.forEach(item => {
                            const unitPrice = item.quantity > 0 ? item.price / item.quantity : 0;
                            const prodNameDisplay = item.quantity > 1 ? `${item.product} (${item.quantity}ê°œ)` : item.product;
                            
                            data.push({
                                'ë‹‰ë„¤ì„': nick,
                                'ìƒí’ˆëª…': prodNameDisplay,
                                'ë‹¨ê°€': unitPrice.toLocaleString(),
                                'ì…ê¸ˆì—¬ë¶€': depositStatus
                            });
                        });
                    }
                });
                
                if (data.length === 0) { alert("ë¯¸ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                data.sort((a, b) => a['ë‹‰ë„¤ì„'].localeCompare(b['ë‹‰ë„¤ì„']));
                downloadExcel(data, 'ë¯¸ì…ê¸ˆì_ìƒì„¸ë¦¬ìŠ¤íŠ¸');
           };
           
           const fileInputRef = useRef(null); 

            return (
                <div className="flex flex-col items-center justify-center h-full p-10 gap-6 overflow-y-auto">
                    <div className="grid grid-cols-2 gap-6 w-full max-w-5xl"> 
                        <div className="bg-white p-6 rounded-xl shadow-lg border text-center">
                            <h2 className="text-lg font-bold mb-2">ë°œì£¼ìš© í’ˆëª© ì§‘ê³„</h2>
                            <button onClick={handleExportProducts} className="w-full bg-green-600 text-white font-bold py-2 rounded-lg">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-lg border text-center">
                            <h2 className="text-lg font-bold mb-2">ë°°ì†¡ìš© ê³ ê° ë¦¬ìŠ¤íŠ¸ (ì „ì²´)</h2>
                            <p className="text-gray-500 mb-2 text-xs">ì…ê¸ˆì™„ë£Œ ìƒë‹¨ / ë…¸ì‡¼ í•˜ë‹¨ ì •ë ¬</p>
                            <button onClick={handleExportCustomers} className="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-lg border text-center ring-2 ring-red-100">
                            <h2 className="text-lg font-bold mb-2 text-red-600">ë¯¸ì…ê¸ˆì ìƒì„¸ ë¦¬ìŠ¤íŠ¸</h2>
                            <p className="text-gray-500 mb-2 text-xs">ìƒí’ˆë³„ í•œ ì¤„ì”© ë³´ê¸°</p>
                            <button onClick={handleExportUnpaid} className="w-full bg-red-500 text-white font-bold py-2 rounded-lg">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-200 text-center"><h2 className="text-lg font-bold mb-2 text-indigo-800">ë°ì´í„° ë°±ì—…</h2><p className="text-gray-500 mb-2 text-xs">ì „ì²´ ë°ì´í„° ì €ì¥/ë³µêµ¬</p><div className="flex gap-2"><button onClick={handleExportBackup} className="flex-1 bg-indigo-600 text-white font-bold py-2 rounded-lg">ì €ì¥</button><input type="file" ref={fileInputRef} onChange={handleImportBackup} className="hidden" /><button onClick={() => fileInputRef.current.click()} className="flex-1 bg-slate-500 text-white font-bold py-2 rounded-lg">ë³µêµ¬</button></div></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [orders, setOrders] = useLocalStorage('youtubeOrders', []);
            const [activeTab, setActiveTab] = useState('live');
            const [quickShipping, setQuickShipping] = useState(4000); 
            const [bankAccount, setBankAccount] = useLocalStorage('bankAccount', FIXED_BANK_ACCOUNT);
            const [productHistory, setProductHistory] = useLocalStorage('productHistory', {});
            const [shippingOverrides, setShippingOverrides] = useLocalStorage('shippingOverrides', {});
            const [addresses, setAddresses] = useLocalStorage('verifiedAddresses', []);
            const [cardPayments, setCardPayments] = useLocalStorage('cardPayments', {});
            const [csData, setCsData] = useLocalStorage('csHistory', []);
            const [matchedDeposits, setMatchedDeposits] = useState(() => { const saved = localStorage.getItem('matchedDeposits'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [depositorNames, setDepositorNames] = useLocalStorage('depositorNames', {});
            const [clickedChats, setClickedChats] = useState(() => { const saved = localStorage.getItem('clickedChats'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [keywords, setKeywords] = useState(() => { const saved = localStorage.getItem('keywords'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [sentAddressRequests, setSentAddressRequests] = useState(() => { const saved = localStorage.getItem('sentAddressRequests'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [deletedDepositIds, setDeletedDepositIds] = useState(() => { const saved = localStorage.getItem('deletedDepositIds'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [checkedOrders, setCheckedOrders] = useState(() => { const saved = localStorage.getItem('checkedOrders'); return saved ? new Set(JSON.parse(saved)) : new Set(); });
            const [addressMapping, setAddressMapping] = useLocalStorage('addressMapping', {});
            const [specialCustomers, setSpecialCustomers] = useLocalStorage('specialCustomers', {});
            const [inventory, setInventory] = useLocalStorage('productInventory', {});
            const [templateConfig, setTemplateConfig] = useLocalStorage('templateConfig', { emoji: 'ğŸ’™', paidMsg: 'ğŸ˜ ì™„ë‚© í™•ì¸! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜', unpaidPrefix: '[ë¯¸ì…ê¸ˆ]\nì´ ì…ê¸ˆí•˜ì‹¤ ê¸ˆì•¡\nğŸ‘‰', addrNotice: 'â€» ë°°ì†¡ì§€ ë³€ê²½ ì‹œ ì±„íŒ…ìœ¼ë¡œ ë³€ê²½í•  ì£¼ì†Œë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!', surveyNotice: 'ë°©ì†¡ë§ˆë‹¤ 1íšŒ\ní•˜ë‹¨ì˜ ì£¼ë¬¸ì„œ(ë°°ì†¡ì§€ì…ë ¥) í•„ìˆ˜!!\n\nì´ë¯¸ ì°¸ì—¬í•œ ì„¤ë¬¸ ì¼ ê²½ìš°\nâ–« ë‹µë³€ ìˆ˜ì •í•˜ê¸° \nâ–« ë˜ëŠ” ì„¤ë¬¸ ì¶”ê°€ ì°¸ì—¬\n\në¯¸ì…ë ¥ì´ ë§ì•„ ê³„ì† ì•ˆë‚´í•©ë‹ˆë‹¤. \nì–‘í•´ë¶€íƒë“œë¦½ë‹ˆë‹¤.' });
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [googleScriptUrl, setGoogleScriptUrl] = useLocalStorage('googleScriptUrl', DEFAULT_GOOGLE_SCRIPT_URL);
            const [customerSheetId, setCustomerSheetId] = useLocalStorage('customerSheetId', DEFAULT_CUSTOMER_SHEET_ID);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, type: 'alert', message: '', onConfirm: null, initialValue: '' });

            const openModal = (message, type = 'alert', onConfirm = null, onCancel = null, initialValue = '') => { setModalConfig({ isOpen: true, type, message, onConfirm: (val) => { if (onConfirm) onConfirm(val); setModalConfig(prev => ({ ...prev, isOpen: false })); }, onCancel: () => { if (onCancel) onCancel(); setModalConfig(prev => ({ ...prev, isOpen: false })); }, initialValue }); };
            
            useEffect(() => { localStorage.setItem('matchedDeposits', JSON.stringify([...matchedDeposits])); }, [matchedDeposits]);
            useEffect(() => { localStorage.setItem('clickedChats', JSON.stringify([...clickedChats])); }, [clickedChats]);
            useEffect(() => { localStorage.setItem('keywords', JSON.stringify([...keywords])); }, [keywords]);
            useEffect(() => { localStorage.setItem('sentAddressRequests', JSON.stringify([...sentAddressRequests])); }, [sentAddressRequests]);
            useEffect(() => { localStorage.setItem('deletedDepositIds', JSON.stringify([...deletedDepositIds])); }, [deletedDepositIds]);
            useEffect(() => { localStorage.setItem('checkedOrders', JSON.stringify([...checkedOrders])); }, [checkedOrders]);

            const resetAllStatus = () => {
                openModal("ì£¼ë¬¸ì„œ, ì±„íŒ…, ì…ê¸ˆë§¤ì¹­ ë‚´ì—­ë§Œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\n(ì£¼ì†Œë¡, VIPëª…ë‹¨, ì¬ê³ , ìƒí’ˆë‹¨ê°€ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)", 'confirm', () => {
                    setOrders([]); setCardPayments({}); setShippingOverrides({}); setMatchedDeposits(new Set()); setClickedChats(new Set()); setSentAddressRequests(new Set()); setDeletedDepositIds(new Set()); setCheckedOrders(new Set());
                    ['youtubeOrders', 'cardPayments', 'shippingOverrides', 'matchedDeposits', 'clickedChats', 'sentAddressRequests', 'deletedDepositIds', 'checkedOrders'].forEach(k => localStorage.removeItem(k));
                    openModal("ë°©ì†¡ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ê³ ê° ì •ë³´ì™€ ì¬ê³ ëŠ” ì•ˆì „í•˜ê²Œ ë³´ì¡´ë˜ì—ˆìŠµë‹ˆë‹¤.)", 'alert');
                });
            };
            
            const handleExportBackup = () => { const backupData = { date: new Date().toISOString(), orders, productHistory, shippingOverrides, cardPayments, matchedDeposits: [...matchedDeposits], clickedChats: [...clickedChats], sentAddressRequests: [...sentAddressRequests], deletedDepositIds: [...deletedDepositIds], checkedOrders: [...checkedOrders], addressMapping, specialCustomers, inventory, templateConfig, depositorNames, keywords: [...keywords] }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "kallo_backup_" + new Date().toISOString().slice(0,10) + ".json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); };
            const handleImportBackup = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = JSON.parse(event.target.result); openModal("ë°±ì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?", 'confirm', () => { if(data.orders) setOrders(data.orders); if(data.productHistory) setProductHistory(data.productHistory); if(data.shippingOverrides) setShippingOverrides(data.shippingOverrides); if(data.cardPayments) setCardPayments(data.cardPayments); if(data.matchedDeposits) setMatchedDeposits(new Set(data.matchedDeposits)); if(data.clickedChats) setClickedChats(new Set(data.clickedChats)); if(data.sentAddressRequests) setSentAddressRequests(new Set(data.sentAddressRequests)); if(data.deletedDepositIds) setDeletedDepositIds(new Set(data.deletedDepositIds)); if(data.checkedOrders) setCheckedOrders(new Set(data.checkedOrders)); if(data.addressMapping) setAddressMapping(data.addressMapping); if(data.specialCustomers) setSpecialCustomers(data.specialCustomers); if(data.inventory) setInventory(data.inventory); if(data.templateConfig) setTemplateConfig(data.templateConfig); if(data.depositorNames) setDepositorNames(data.depositorNames); if(data.keywords) setKeywords(new Set(data.keywords)); openModal("ë³µêµ¬ ì™„ë£Œ!", 'alert'); }); } catch(err) { openModal("íŒŒì¼ ì½ê¸° ì‹¤íŒ¨", 'alert'); } }; reader.readAsText(file); e.target.value = ''; };

            if (!isLoggedIn) return <LoginScreen onLogin={() => setIsLoggedIn(true)} />;

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700">
                     <header className="h-12 bg-indigo-900 text-white flex items-center justify-between px-4 shrink-0 shadow-md z-50">
                        <div className="font-bold text-lg flex items-center gap-2"><Icon name="lightning" className="text-yellow-400" weight="fill"/> ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO</div>
                        <div className="flex items-center gap-2">
                            <div className="flex bg-indigo-800 rounded p-1 gap-1">
                                {[{ id: 'live', label: 'ë¼ì´ë¸Œê´€ì œ', icon: 'monitor-play' }, { id: 'status', label: 'ì¬ê³ /ë°œì£¼', icon: 'clipboard-text' }, { id: 'customer', label: 'ê³ ê°ê´€ë¦¬', icon: 'address-book' }, { id: 'cs', label: 'CSê´€ë¦¬', icon: 'headset' }, { id: 'manage', label: 'ì£¼ë¬¸ê´€ë¦¬(ì—‘ì…€)', icon: 'file-xls' }].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 transition-all ${activeTab === tab.id ? 'bg-white text-indigo-900 shadow' : 'text-indigo-300 hover:text-white'}`}><Icon name={tab.icon} weight="bold"/> {tab.label}</button>
                                ))}
                            </div>
                            <button onClick={()=>setIsSettingsOpen(!isSettingsOpen)} className="p-2 hover:bg-indigo-800 rounded text-indigo-300 hover:text-white"><Icon name="gear" weight="fill" size={20}/></button>
                        </div>
                    </header>
                    <Modal isOpen={modalConfig.isOpen} type={modalConfig.type} message={modalConfig.message} onConfirm={modalConfig.onConfirm} onCancel={modalConfig.onCancel} initialValue={modalConfig.initialValue} />
                     {isSettingsOpen && (
                        <div className="absolute top-12 right-4 bg-white shadow-xl border rounded-lg p-4 w-96 z-50 animate-pop max-h-[80vh] overflow-y-auto">
                            <h3 className="font-bold mb-4 flex items-center gap-2 border-b pb-2"><Icon name="gear" weight="fill" className="text-gray-500"/> í™˜ê²½ì„¤ì •</h3>
                            <div className="mb-4 space-y-4">
                                <div><label className="block text-xs font-bold text-indigo-600 mb-1">êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL</label><input type="text" value={googleScriptUrl} onChange={(e)=>setGoogleScriptUrl(e.target.value)} className="w-full border rounded px-2 py-1.5 text-xs text-gray-600 font-mono break-all" /></div>
                                <div><label className="block text-xs font-bold text-green-600 mb-1">ê³ ê° ì£¼ì†Œë¡ ì‹œíŠ¸ ID</label><input type="text" value={customerSheetId} onChange={(e)=>setCustomerSheetId(e.target.value)} className="w-full border rounded px-2 py-1.5 text-xs text-gray-600 font-mono" /></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1">ê¸°ë³¸ ë°°ì†¡ë¹„</label><input type="number" value={quickShipping} onChange={(e)=>setQuickShipping(Number(e.target.value))} className="w-full border rounded px-2 py-1.5 text-sm" /></div>
                                <div className="border-t pt-4"><h4 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-1"><Icon name="chat-text" weight="fill"/> ì£¼ë¬¸ì„œ ë©˜íŠ¸ ì„¤ì •</h4><div className="space-y-3">
                                    <div><label className="block text-[10px] font-bold text-gray-500 mb-1">ë‹‰ë„¤ì„ ì´ëª¨ì§€</label><input type="text" value={templateConfig.emoji} onChange={(e)=>setTemplateConfig({...templateConfig, emoji: e.target.value})} className="w-full border rounded px-2 py-1.5 text-sm" /></div>
                                    <div className="flex flex-wrap gap-1 bg-slate-50 p-1.5 rounded border border-slate-100">{["ğŸ’™", "ğŸ’–", "ğŸ’›", "ğŸ’š", "ğŸ’œ", "ğŸ¤", "â­", "ğŸŒŸ", "âœ¨", "ğŸŒ¸", "ğŸŒ¼", "ğŸ€", "âœ…", "ğŸ", "ğŸ“¢", "ğŸŒˆ", "ğŸ”¥", "ğŸ’"].map(em => (<button key={em} onClick={() => setTemplateConfig({...templateConfig, emoji: em})} className="w-5 h-5 flex items-center justify-center hover:bg-white rounded hover:shadow-sm transition-all text-xs">{em}</button>))}</div>
                                    <div><label className="block text-[10px] font-bold text-gray-500 mb-1">ì™„ë‚© ë©”ì‹œì§€</label><input type="text" value={templateConfig.paidMsg} onChange={(e)=>setTemplateConfig({...templateConfig, paidMsg: e.target.value})} className="w-full border rounded px-2 py-1.5 text-sm" /></div>
                                    <div><label className="block text-[10px] font-bold text-gray-500 mb-1">ë¯¸ë‚© ì•ˆë‚´</label><textarea value={templateConfig.unpaidPrefix} onChange={(e)=>setTemplateConfig({...templateConfig, unpaidPrefix: e.target.value})} className="w-full border rounded px-2 py-1.5 text-xs h-16 resize-none" /></div>
                                    <div><label className="block text-[10px] font-bold text-gray-500 mb-1">ê³„ì¢Œë²ˆí˜¸</label><textarea value={bankAccount} onChange={(e)=>setBankAccount(e.target.value)} className="w-full border rounded px-2 py-1.5 text-xs h-12 resize-none" /></div>
                                    <div><label className="block text-[10px] font-bold text-gray-500 mb-1">ì£¼ì†Œ ìˆìŒ ì•ˆë‚´</label><textarea value={templateConfig.addrNotice} onChange={(e)=>setTemplateConfig({...templateConfig, addrNotice: e.target.value})} className="w-full border rounded px-2 py-1.5 text-xs h-12 resize-none" /></div>
                                    <div><label className="block text-[10px] font-bold text-gray-500 mb-1">ì£¼ì†Œ ì—†ìŒ ì•ˆë‚´</label><textarea value={templateConfig.surveyNotice} onChange={(e)=>setTemplateConfig({...templateConfig, surveyNotice: e.target.value})} className="w-full border rounded px-2 py-1.5 text-xs h-24 resize-none" /></div>
                                </div></div>
                            </div>
                            <button onClick={()=>setIsSettingsOpen(false)} className="w-full bg-indigo-600 text-white rounded py-2 text-sm font-bold hover:bg-indigo-700 sticky bottom-0">ì €ì¥ ë° ë‹«ê¸°</button>
                        </div>
                    )}
                     <main className="flex-1 overflow-hidden bg-gray-200 p-2 relative">
                        {activeTab === 'live' && <LiveTab {...{ orders, setOrders, productHistory, setProductHistory, quickShipping, shippingOverrides, setShippingOverrides, bankAccount, googleScriptUrl, addresses, cardPayments, setCardPayments, resetAllStatus, matchedDeposits, setMatchedDeposits, depositorNames, setDepositorNames, clickedChats, setClickedChats, openModal, keywords, setKeywords, sentAddressRequests, setSentAddressRequests, deletedDepositIds, setDeletedDepositIds, checkedOrders, setCheckedOrders, addressMapping, setAddressMapping, templateConfig, specialCustomers, inventory }} />}
                        {activeTab === 'status' && <OrderStatusTab {...{ orders, setOrders, setProductHistory, productHistory, inventory, setInventory }} />}
                        {activeTab === 'customer' && <CustomerTab {...{ addresses, setAddresses, googleScriptUrl, customerSheetId, openModal, specialCustomers, setSpecialCustomers }} />}
                        {activeTab === 'cs' && <CSTab {...{ csData, setCsData, openModal }} />}
                        {activeTab === 'manage' && <OrderManagementTab {...{ orders, shippingOverrides, quickShipping, addresses, handleExportBackup, handleImportBackup, addressMapping, cardPayments }} />}
                     </main>
                </div>
             )
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
